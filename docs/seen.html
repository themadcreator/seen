<!DOCTYPE html>

<html>
<head>
  <title>seen.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>seen.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2 id="apache-2-0-license">Apache 2.0 License</h2>
<pre><code>Copyright <span class="hljs-number">2013</span> github/themadcreator
</code></pre><p>   Licensed under the Apache License, Version 2.0 (the “License”);
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at</p>
<pre><code>   <span class="hljs-attribute">http</span>:<span class="hljs-regexp">//</span>www.apache.org/licenses/LICENSE-<span class="hljs-number">2.0</span>
</code></pre><p>   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an “AS IS” BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="init">Init</h2>
<h4 id="module-definition">Module definition</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Declare and attach seen namespace</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen = (<span class="hljs-built_in">exports</span> ? <span class="hljs-keyword">this</span>).seen = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="utils">Utils</h2>
<h4 id="utility-methods">Utility methods</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
NEXT_UNIQUE_ID = <span class="hljs-number">1</span>

seen.Util = {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Copies default values. First, overwrite undefined attributes of <code>obj</code> from <code>opts</code>. Second, overwrite undefined attributes of <code>obj</code> from <code>defaults</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">defaults</span>: <span class="hljs-function"><span class="hljs-params">(obj, opts, defaults)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> prop <span class="hljs-keyword">of</span> opts
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> obj[prop]? <span class="hljs-keyword">then</span> obj[prop] = opts[prop]
    <span class="hljs-keyword">for</span> prop <span class="hljs-keyword">of</span> defaults
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> obj[prop]? <span class="hljs-keyword">then</span> obj[prop] = defaults[prop]</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Returns <code>true</code> iff the supplied <code>Arrays</code> are the same size and contain the same values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">arraysEqual</span>: <span class="hljs-function"><span class="hljs-params">(a, b)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> a.length == b.length <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">for</span> val, i <span class="hljs-keyword">in</span> a
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (val == b[i]) <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Returns an ID which is unique to this instance of the library</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">uniqueId</span>: <span class="hljs-function"><span class="hljs-params">(prefix = <span class="hljs-string">''</span>)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> prefix + NEXT_UNIQUE_ID++

  element : <span class="hljs-function"><span class="hljs-params">(elementOrString)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> elementOrString <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.getElementById(elementOrString)
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> elementOrString
}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="events">Events</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Attribution: these have been adapted from d3.js’s event dispatcher functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
seen.Events = {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Return a new dispatcher that creates event types using
the supplied string argument list. The returned <code>Dispatcher</code>
will have methods with the names of the event types.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dispatch : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    dispatch = <span class="hljs-keyword">new</span> seen.Events.Dispatcher()
    <span class="hljs-keyword">for</span> arg <span class="hljs-keyword">in</span> arguments
      dispatch[arg] = seen.Events.Event()
    <span class="hljs-keyword">return</span> dispatch
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>The <code>Dispatcher</code> class. These objects have methods that can be invoked like dispatch.eventName().
Listeners can be registered with dispatch.on(‘eventName.uniqueId’, callback). Listeners can
be removed with dispatch.on(‘eventName.uniqueId’, null).</p>
<p>Note that only one listener with the name event name and id can be registered at once. If you
to generate unique ids, you can use the seen.Util.uniqueId() method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Events</span>.<span class="hljs-title">Dispatcher</span></span>
  <span class="hljs-literal">on</span> : <span class="hljs-function"><span class="hljs-params">(type, listener)</span> =&gt;</span>
    i = type.indexOf <span class="hljs-string">'.'</span>
    name = <span class="hljs-string">''</span>
    <span class="hljs-keyword">if</span> i &gt; <span class="hljs-number">0</span>
      name = type.substring(i + <span class="hljs-number">1</span>)
      type = type.substring(<span class="hljs-number">0</span>, i)

    <span class="hljs-keyword">if</span> @[type]?
      @[type].<span class="hljs-literal">on</span>(name, listener)

    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Internal event object for storing listener callbacks and a map for easy lookup.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.Events.<span class="hljs-function"><span class="hljs-title">Event</span> = -&gt;</span>
  <span class="hljs-function"><span class="hljs-title">event</span> = -&gt;</span>
    <span class="hljs-keyword">for</span> name, l <span class="hljs-keyword">of</span> event.listenerMap
      <span class="hljs-keyword">if</span> l? <span class="hljs-keyword">then</span> l.apply(@, arguments)

  event.listenerMap = {}

  event.<span class="hljs-function"><span class="hljs-title">on</span> = <span class="hljs-params">(name, listener)</span> -&gt;</span>
    <span class="hljs-keyword">delete</span> event.listenerMap[name]

    <span class="hljs-keyword">if</span> listener
      event.listenerMap[name] = listener

  <span class="hljs-keyword">return</span> event</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h2 id="math">Math</h2>
<h4 id="matrices-points-and-other-mathy-stuff">Matrices, points, and other mathy stuff</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Pool object to speed computation and reduce object creation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>ARRAY_POOL = <span class="hljs-keyword">new</span> Array(<span class="hljs-number">16</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Definition of identity matrix values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>IDENTITY = [<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>,
            <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>,
            <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>,
            <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>]

TRANSPOSE_INDICES = [<span class="hljs-number">0</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">8</span>, <span class="hljs-number">12</span>,
                     <span class="hljs-number">1</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">13</span>,
                     <span class="hljs-number">2</span>,  <span class="hljs-number">6</span>, <span class="hljs-number">10</span>, <span class="hljs-number">14</span>,
                     <span class="hljs-number">3</span>,  <span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">15</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>The <code>Matrix</code> class stores transformations in the scene. These include:
(1) Camera Projection and Viewport transformations.
(2) Transformations of any <code>Transformable</code> type object, such as <code>Shapes</code></p>
<p><code>Matrix</code> objects have two sets of manipulation methods.
Normal methods (e.g. <code>translate</code>) are <strong>non-destructive</strong> — i.e. they return a new object without modifying the existing object.
Underscored methods (e.g. <code>_translate</code>) are <strong>destructive</strong> — i.e. they modifying and return the existing object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Matrix</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Accepts a 16-value <code>Array</code>, defaults to the identity matrix.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@m</span> = <span class="hljs-literal">null</span>)</span> -&gt;</span>
    <span class="hljs-property">@m</span> ?= IDENTITY.slice()
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Returns a new matrix instances with a copy of the value array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">copy</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Matrix(<span class="hljs-property">@m</span>.slice())</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Returns a new matrix which is the transpose of this matrix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">transpose</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Matrix<span class="hljs-function"><span class="hljs-params">(TRANSPOSE_INDICES.map((i) =&gt; <span class="hljs-property">@m</span>[i]))</span>

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Resets the matrix to the identity matrix.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">reset</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@m</span> = IDENTITY.slice()
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Multiply by the <code>Matrix</code> argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">multiply</span>: <span class="hljs-function"><span class="hljs-params">(b)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-property">@matrix</span>(b.m)</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Multiply by the 16-value <code>Array</code> argument. This method uses the <code>ARRAY_POOL</code>, which prevents us from having to re-initialize a new temporary matrix every time. This drastically improves performance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">matrix</span>: <span class="hljs-function"><span class="hljs-params">(m)</span> -&gt;</span>
    c = ARRAY_POOL
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.<span class="hljs-number">.4</span>]
      <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.<span class="hljs-number">.16</span>] <span class="hljs-keyword">by</span> <span class="hljs-number">4</span>
        c[i + j] =
          m[i    ] * <span class="hljs-property">@m</span>[     j] +
          m[i + <span class="hljs-number">1</span>] * <span class="hljs-property">@m</span>[ <span class="hljs-number">4</span> + j] +
          m[i + <span class="hljs-number">2</span>] * <span class="hljs-property">@m</span>[ <span class="hljs-number">8</span> + j] +
          m[i + <span class="hljs-number">3</span>] * <span class="hljs-property">@m</span>[<span class="hljs-number">12</span> + j]
    ARRAY_POOL = <span class="hljs-property">@m</span>
    <span class="hljs-property">@m</span> = c
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Apply a rotation about the X axis. <code>Theta</code> is measured in Radians</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">rotx</span>: <span class="hljs-function"><span class="hljs-params">(theta)</span> -&gt;</span>
    ct = Math.cos(theta)
    st = Math.sin(theta)
    rm = [ <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, ct, -st, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, st, ct, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> ]
    <span class="hljs-keyword">return</span> <span class="hljs-property">@matrix</span>(rm)</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Apply a rotation about the Y axis. <code>Theta</code> is measured in Radians</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">roty</span>: <span class="hljs-function"><span class="hljs-params">(theta)</span>  -&gt;</span>
    ct = Math.cos(theta)
    st = Math.sin(theta)
    rm = [ ct, <span class="hljs-number">0</span>, st, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -st, <span class="hljs-number">0</span>, ct, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> ]
    <span class="hljs-keyword">return</span> <span class="hljs-property">@matrix</span>(rm)</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Apply a rotation about the Z axis. <code>Theta</code> is measured in Radians</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">rotz</span>: <span class="hljs-function"><span class="hljs-params">(theta)</span> -&gt;</span>
    ct = Math.cos(theta)
    st = Math.sin(theta)
    rm = [ ct, -st, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, st, ct, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> ]
    <span class="hljs-keyword">return</span> <span class="hljs-property">@matrix</span>(rm)</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Apply a translation. All arguments default to <code>0</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">translate</span>: <span class="hljs-function"><span class="hljs-params">(x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>, z = <span class="hljs-number">0</span>)</span> -&gt;</span>
    <span class="hljs-property">@m</span>[<span class="hljs-number">3</span>]  += x
    <span class="hljs-property">@m</span>[<span class="hljs-number">7</span>]  += y
    <span class="hljs-property">@m</span>[<span class="hljs-number">11</span>] += z
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Apply a scale. If not all arguments are supplied, each dimension (x,y,z) is copied from the previous arugment. Therefore, <code>_scale()</code> is equivalent to <code>_scale(1,1,1)</code>, and <code>_scale(1,-1)</code> is equivalent to <code>_scale(1,-1,-1)</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">scale</span>: <span class="hljs-function"><span class="hljs-params">(sx, sy, sz, sw)</span> -&gt;</span>
    sx     ?= <span class="hljs-number">1</span>
    sy     ?= sx
    sz     ?= sy
    sw     ?= sz
    <span class="hljs-property">@m</span>[<span class="hljs-number">0</span>]  *= sx
    <span class="hljs-property">@m</span>[<span class="hljs-number">5</span>]  *= sy
    <span class="hljs-property">@m</span>[<span class="hljs-number">10</span>] *= sz
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>A convenience method for constructing Matrix objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.<span class="hljs-function"><span class="hljs-title">M</span> = <span class="hljs-params">(m)</span> -&gt;</span> <span class="hljs-keyword">new</span> seen.Matrix(m)</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>A few useful Matrix objects. Be careful not to apply destructive operations to these objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.Matrices = {
  identity :<span class="hljs-function"> -&gt;</span> seen.M()
  flipX    :<span class="hljs-function"> -&gt;</span> seen.M().scale(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
  flipY    :<span class="hljs-function"> -&gt;</span> seen.M().scale( <span class="hljs-number">1</span>,-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
  flipZ    :<span class="hljs-function"> -&gt;</span> seen.M().scale( <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,-<span class="hljs-number">1</span>)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><code>Transformable</code> base class extended by <code>Shape</code> and <code>Model</code>.</p>
<p>The advantages of keeping transforms in <code>Matrix</code> form are (1) lazy computation of point position (2) ability combine hierarchical transformations easily (3) ability to reset transformations to an original state.</p>
<p>Resetting transformations is especially useful when you want to animate interpolated values. Instead of computing the difference at each animation step, you can compute the global interpolated value for that time step and apply that value directly to a matrix (once it is reset).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Transformable</span></span>
  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@m</span> = <span class="hljs-keyword">new</span> seen.Matrix()
    <span class="hljs-keyword">for</span> method <span class="hljs-keyword">in</span> [<span class="hljs-string">'scale'</span>, <span class="hljs-string">'translate'</span>, <span class="hljs-string">'rotx'</span>, <span class="hljs-string">'roty'</span>, <span class="hljs-string">'rotz'</span>, <span class="hljs-string">'matrix'</span>, <span class="hljs-string">'reset'</span>] <span class="hljs-keyword">then</span> <span class="hljs-keyword">do</span> <span class="hljs-function"><span class="hljs-params">(method)</span> =&gt;</span>
      @[method] =<span class="hljs-function"> -&gt;</span>
        <span class="hljs-property">@m</span>[method].call(<span class="hljs-property">@m</span>, arguments...)
        <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Apply a transformation from the supplied <code>Matrix</code>. see <code>Matrix._multiply</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">transform</span>: <span class="hljs-function"><span class="hljs-params">(m)</span> -&gt;</span>
    <span class="hljs-property">@m</span>.multiply(m)
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>The <code>Point</code> object contains x,y,z, and w coordinates. <code>Points</code> support various arithmetic operations with other <code>Points</code>, scalars, or <code>Matrices</code>.</p>
<p>Similar to the <code>Matrix</code> object. <code>Point</code> objects have <strong>non-destructive</strong> (e.g. <code>add</code>) methods, which return a new <code>Point</code> without modifying the current object, and <strong>destrcutive</strong> (e.g. <code>_add</code>) methods which modify the object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Point</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@x</span> = <span class="hljs-number">0</span>, <span class="hljs-property">@y</span> = <span class="hljs-number">0</span>, <span class="hljs-property">@z</span> = <span class="hljs-number">0</span>, <span class="hljs-property">@w</span> = <span class="hljs-number">1</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Creates and returns a new <code>Point</code> with the same values as this object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">copy</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Point(<span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>, <span class="hljs-property">@z</span>, <span class="hljs-property">@w</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Copies the values of the supplied <code>Point</code> into this object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">set</span>: <span class="hljs-function"><span class="hljs-params">(p)</span> -&gt;</span>
    <span class="hljs-property">@x</span> = p.x
    <span class="hljs-property">@y</span> = p.y
    <span class="hljs-property">@z</span> = p.z
    <span class="hljs-property">@w</span> = p.w
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Performs parameter-wise addition with the supplied <code>Point</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">add</span>: <span class="hljs-function"><span class="hljs-params">(q)</span> -&gt;</span>
    <span class="hljs-property">@x</span> += q.x
    <span class="hljs-property">@y</span> += q.y
    <span class="hljs-property">@z</span> += q.z
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Performs parameter-wise subtraction with the supplied <code>Point</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">subtract</span>: <span class="hljs-function"><span class="hljs-params">(q)</span> -&gt;</span>
    <span class="hljs-property">@x</span> -= q.x
    <span class="hljs-property">@y</span> -= q.y
    <span class="hljs-property">@z</span> -= q.z
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Apply a translation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">translate</span>: <span class="hljs-function"><span class="hljs-params">(x, y, z)</span> -&gt;</span>
    <span class="hljs-property">@x</span> += x
    <span class="hljs-property">@y</span> += y
    <span class="hljs-property">@z</span> += z
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Multiplies each parameters by the supplied scalar value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">multiply</span>: <span class="hljs-function"><span class="hljs-params">(n)</span> -&gt;</span>
    <span class="hljs-property">@x</span> *= n
    <span class="hljs-property">@y</span> *= n
    <span class="hljs-property">@z</span> *= n
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Divides each parameters by the supplied scalar value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">divide</span>: <span class="hljs-function"><span class="hljs-params">(n)</span> -&gt;</span>
    <span class="hljs-property">@x</span> /= n
    <span class="hljs-property">@y</span> /= n
    <span class="hljs-property">@z</span> /= n
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Rounds each coordinate to the nearest integer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">round</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@x</span> = Math.round(<span class="hljs-property">@x</span>)
    <span class="hljs-property">@y</span> = Math.round(<span class="hljs-property">@y</span>)
    <span class="hljs-property">@z</span> = Math.round(<span class="hljs-property">@z</span>)
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Divides this <code>Point</code> by its magnitude.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">normalize</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    n = Math.sqrt(<span class="hljs-property">@dot</span>(@))
    <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span>
      <span class="hljs-property">@set</span>(seen.Points.Z)
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@divide</span>(n)
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Apply a transformation from the supplied <code>Matrix</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">transform</span>: <span class="hljs-function"><span class="hljs-params">(matrix)</span> -&gt;</span>
    r = POINT_POOL
    r.x = <span class="hljs-property">@x</span> * matrix.m[<span class="hljs-number">0</span>] + <span class="hljs-property">@y</span> * matrix.m[<span class="hljs-number">1</span>] + <span class="hljs-property">@z</span> * matrix.m[<span class="hljs-number">2</span>] + <span class="hljs-property">@w</span> * matrix.m[<span class="hljs-number">3</span>]
    r.y = <span class="hljs-property">@x</span> * matrix.m[<span class="hljs-number">4</span>] + <span class="hljs-property">@y</span> * matrix.m[<span class="hljs-number">5</span>] + <span class="hljs-property">@z</span> * matrix.m[<span class="hljs-number">6</span>] + <span class="hljs-property">@w</span> * matrix.m[<span class="hljs-number">7</span>]
    r.z = <span class="hljs-property">@x</span> * matrix.m[<span class="hljs-number">8</span>] + <span class="hljs-property">@y</span> * matrix.m[<span class="hljs-number">9</span>] + <span class="hljs-property">@z</span> * matrix.m[<span class="hljs-number">10</span>] + <span class="hljs-property">@w</span> * matrix.m[<span class="hljs-number">11</span>]
    r.w = <span class="hljs-property">@x</span> * matrix.m[<span class="hljs-number">12</span>] + <span class="hljs-property">@y</span> * matrix.m[<span class="hljs-number">13</span>] + <span class="hljs-property">@z</span> * matrix.m[<span class="hljs-number">14</span>] + <span class="hljs-property">@w</span> * matrix.m[<span class="hljs-number">15</span>]

    <span class="hljs-property">@set</span>(r)
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Computes the dot product with the supplied <code>Point</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">dot</span>: <span class="hljs-function"><span class="hljs-params">(q)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-property">@x</span> * q.x + <span class="hljs-property">@y</span> * q.y + <span class="hljs-property">@z</span> * q.z</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Computes the cross product with the supplied <code>Point</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cross</span>: <span class="hljs-function"><span class="hljs-params">(q)</span> -&gt;</span>
    r = POINT_POOL
    r.x = <span class="hljs-property">@y</span> * q.z - <span class="hljs-property">@z</span> * q.y
    r.y = <span class="hljs-property">@z</span> * q.x - <span class="hljs-property">@x</span> * q.z
    r.z = <span class="hljs-property">@x</span> * q.y - <span class="hljs-property">@y</span> * q.x

    <span class="hljs-property">@set</span>(r)
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Convenience method for creating <code>Points</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.<span class="hljs-function"><span class="hljs-title">P</span> = <span class="hljs-params">(x,y,z,w)</span> -&gt;</span> <span class="hljs-keyword">new</span> seen.Point(x,y,z,w)</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>A pool object which prevents us from having to create new <code>Point</code> objects for various calculations, which vastly improves performance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>POINT_POOL = seen.P()</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>A few useful <code>Point</code> objects. Be sure that you don’t invoke destructive methods on these objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.Points = {
  X    : seen.P(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  Y    : seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
  Z    : seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
  ZERO : seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>A Quaterionion class for computing quaterion multiplications. This creates more natural mouse rotations.</p>
<p>Attribution: adapted from <a href="http://glprogramming.com/codedump/godecho/quaternion.html">http://glprogramming.com/codedump/godecho/quaternion.html</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Quaternion</span></span>
  <span class="hljs-property">@pixelsPerRadian</span> : <span class="hljs-number">150</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Convert the x and y pixel offsets into a rotation matrix</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@xyToTransform</span> : <span class="hljs-function"><span class="hljs-params">(x, y)</span> -&gt;</span>
    quatX = seen.Quaternion.pointAngle(seen.Points.Y, x / seen.Quaternion.pixelsPerRadian)
    quatY = seen.Quaternion.pointAngle(seen.Points.X, y / seen.Quaternion.pixelsPerRadian)
    <span class="hljs-keyword">return</span> quatX.multiply(quatY).toMatrix()</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Create a rotation matrix from the axis defined by x, y, and z values, and the supplied angle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@axisAngle</span> : <span class="hljs-function"><span class="hljs-params">(x, y, z, angleRads)</span> -&gt;</span>
    scale = Math.sin(angleRads / <span class="hljs-number">2.0</span>)
    w     = Math.cos(angleRads / <span class="hljs-number">2.0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Quaternion(scale * x, scale * y, scale * z, w)</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Create a rotation matrix from the axis defined by the supplied point and the supplied angle.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@pointAngle</span> : <span class="hljs-function"><span class="hljs-params">(p, angleRads)</span> -&gt;</span>
    scale = Math.sin(angleRads / <span class="hljs-number">2.0</span>)
    w     = Math.cos(angleRads / <span class="hljs-number">2.0</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Quaternion(scale * p.x, scale * p.y, scale * p.z, w)

  constructor :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@q</span> = seen.P(arguments...)</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Multiply this <code>Quaterionion</code> by the <code>Quaternion</code> argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  multiply : <span class="hljs-function"><span class="hljs-params">(q)</span> -&gt;</span>
    r = seen.P()

    r.w = <span class="hljs-property">@q</span>.w * q.q.w - <span class="hljs-property">@q</span>.x * q.q.x - <span class="hljs-property">@q</span>.y * q.q.y - <span class="hljs-property">@q</span>.z * q.q.z
    r.x = <span class="hljs-property">@q</span>.w * q.q.x + <span class="hljs-property">@q</span>.x * q.q.w + <span class="hljs-property">@q</span>.y * q.q.z - <span class="hljs-property">@q</span>.z * q.q.y
    r.y = <span class="hljs-property">@q</span>.w * q.q.y + <span class="hljs-property">@q</span>.y * q.q.w + <span class="hljs-property">@q</span>.z * q.q.x - <span class="hljs-property">@q</span>.x * q.q.z
    r.z = <span class="hljs-property">@q</span>.w * q.q.z + <span class="hljs-property">@q</span>.z * q.q.w + <span class="hljs-property">@q</span>.x * q.q.y - <span class="hljs-property">@q</span>.y * q.q.x

    result = <span class="hljs-keyword">new</span> seen.Quaternion()
    result.q = r
    <span class="hljs-keyword">return</span> result</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Convert this <code>Quaterion</code> into a transformation matrix.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  toMatrix :<span class="hljs-function"> -&gt;</span>
    m = <span class="hljs-keyword">new</span> Array(<span class="hljs-number">16</span>)

    m[ <span class="hljs-number">0</span>] = <span class="hljs-number">1.0</span> - <span class="hljs-number">2.0</span> * ( <span class="hljs-property">@q</span>.y * <span class="hljs-property">@q</span>.y + <span class="hljs-property">@q</span>.z * <span class="hljs-property">@q</span>.z )
    m[ <span class="hljs-number">1</span>] = <span class="hljs-number">2.0</span> * ( <span class="hljs-property">@q</span>.x * <span class="hljs-property">@q</span>.y - <span class="hljs-property">@q</span>.w * <span class="hljs-property">@q</span>.z )
    m[ <span class="hljs-number">2</span>] = <span class="hljs-number">2.0</span> * ( <span class="hljs-property">@q</span>.x * <span class="hljs-property">@q</span>.z + <span class="hljs-property">@q</span>.w * <span class="hljs-property">@q</span>.y )
    m[ <span class="hljs-number">3</span>] = <span class="hljs-number">0.0</span>

    m[ <span class="hljs-number">4</span>] = <span class="hljs-number">2.0</span> * ( <span class="hljs-property">@q</span>.x * <span class="hljs-property">@q</span>.y + <span class="hljs-property">@q</span>.w * <span class="hljs-property">@q</span>.z )
    m[ <span class="hljs-number">5</span>] = <span class="hljs-number">1.0</span> - <span class="hljs-number">2.0</span> * ( <span class="hljs-property">@q</span>.x * <span class="hljs-property">@q</span>.x + <span class="hljs-property">@q</span>.z * <span class="hljs-property">@q</span>.z )
    m[ <span class="hljs-number">6</span>] = <span class="hljs-number">2.0</span> * ( <span class="hljs-property">@q</span>.y * <span class="hljs-property">@q</span>.z - <span class="hljs-property">@q</span>.w * <span class="hljs-property">@q</span>.x )
    m[ <span class="hljs-number">7</span>] = <span class="hljs-number">0.0</span>

    m[ <span class="hljs-number">8</span>] = <span class="hljs-number">2.0</span> * ( <span class="hljs-property">@q</span>.x * <span class="hljs-property">@q</span>.z - <span class="hljs-property">@q</span>.w * <span class="hljs-property">@q</span>.y )
    m[ <span class="hljs-number">9</span>] = <span class="hljs-number">2.0</span> * ( <span class="hljs-property">@q</span>.y * <span class="hljs-property">@q</span>.z + <span class="hljs-property">@q</span>.w * <span class="hljs-property">@q</span>.x )
    m[<span class="hljs-number">10</span>] = <span class="hljs-number">1.0</span> - <span class="hljs-number">2.0</span> * ( <span class="hljs-property">@q</span>.x * <span class="hljs-property">@q</span>.x + <span class="hljs-property">@q</span>.y * <span class="hljs-property">@q</span>.y )
    m[<span class="hljs-number">11</span>] = <span class="hljs-number">0.0</span>

    m[<span class="hljs-number">12</span>] = <span class="hljs-number">0</span>
    m[<span class="hljs-number">13</span>] = <span class="hljs-number">0</span>
    m[<span class="hljs-number">14</span>] = <span class="hljs-number">0</span>
    m[<span class="hljs-number">15</span>] = <span class="hljs-number">1.0</span>
    <span class="hljs-keyword">return</span> seen.M(m)</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <h2 id="color">Color</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p><code>Color</code> objects store RGB and Alpha values from 0 to 255.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Color</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@r</span> = <span class="hljs-number">0</span>, <span class="hljs-property">@g</span> = <span class="hljs-number">0</span>, <span class="hljs-property">@b</span> = <span class="hljs-number">0</span>, <span class="hljs-property">@a</span> = <span class="hljs-number">0xFF</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Returns a new <code>Color</code> object with the same rgb and alpha values as the current object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">copy</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Color(<span class="hljs-property">@r</span>, <span class="hljs-property">@g</span>, <span class="hljs-property">@b</span>, <span class="hljs-property">@a</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Scales the rgb channels by the supplied scalar value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">scale</span>: <span class="hljs-function"><span class="hljs-params">(n)</span> -&gt;</span>
    <span class="hljs-property">@r</span> *= n
    <span class="hljs-property">@g</span> *= n
    <span class="hljs-property">@b</span> *= n
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Offsets each rgb channel by the supplied scalar value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">offset</span>: <span class="hljs-function"><span class="hljs-params">(n)</span> -&gt;</span>
    <span class="hljs-property">@r</span> += n
    <span class="hljs-property">@g</span> += n
    <span class="hljs-property">@b</span> += n
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Clamps each rgb channel to the supplied minimum and maximum scalar values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">clamp</span>: <span class="hljs-function"><span class="hljs-params">(min = <span class="hljs-number">0</span>, max = <span class="hljs-number">0xFF</span>)</span> -&gt;</span>
    <span class="hljs-property">@r</span> = Math.min(max, Math.max(min, <span class="hljs-property">@r</span>))
    <span class="hljs-property">@g</span> = Math.min(max, Math.max(min, <span class="hljs-property">@g</span>))
    <span class="hljs-property">@b</span> = Math.min(max, Math.max(min, <span class="hljs-property">@b</span>))
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Takes the minimum between each channel of this <code>Color</code> and the supplied <code>Color</code> object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">minChannels</span>: <span class="hljs-function"><span class="hljs-params">(c)</span> -&gt;</span>
    <span class="hljs-property">@r</span> = Math.min(c.r, <span class="hljs-property">@r</span>)
    <span class="hljs-property">@g</span> = Math.min(c.g, <span class="hljs-property">@g</span>)
    <span class="hljs-property">@b</span> = Math.min(c.b, <span class="hljs-property">@b</span>)
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Adds the channels of the current <code>Color</code> with each respective channel from the supplied <code>Color</code> object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">addChannels</span>: <span class="hljs-function"><span class="hljs-params">(c)</span> -&gt;</span>
    <span class="hljs-property">@r</span> += c.r
    <span class="hljs-property">@g</span> += c.g
    <span class="hljs-property">@b</span> += c.b
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Multiplies the channels of the current <code>Color</code> with each respective channel from the supplied <code>Color</code> object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">multiplyChannels</span>: <span class="hljs-function"><span class="hljs-params">(c)</span> -&gt;</span>
    <span class="hljs-property">@r</span> *= c.r
    <span class="hljs-property">@g</span> *= c.g
    <span class="hljs-property">@b</span> *= c.b
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Converts the <code>Color</code> into a hex string of the form “#RRGGBB”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">hex</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    c = (<span class="hljs-property">@r</span> &lt;&lt; <span class="hljs-number">16</span> | <span class="hljs-property">@g</span> &lt;&lt; <span class="hljs-number">8</span> | <span class="hljs-property">@b</span>).toString(<span class="hljs-number">16</span>)
    <span class="hljs-keyword">while</span> (c.length &lt; <span class="hljs-number">6</span>) <span class="hljs-keyword">then</span> c = <span class="hljs-string">'0'</span> + c
    <span class="hljs-keyword">return</span> <span class="hljs-string">'#'</span> + c</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Converts the <code>Color</code> into a CSS-style string of the form “rgba(RR, GG, BB, AA)”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">style</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"rgba(<span class="hljs-subst">#{<span class="hljs-property">@r</span>}</span>,<span class="hljs-subst">#{<span class="hljs-property">@g</span>}</span>,<span class="hljs-subst">#{<span class="hljs-property">@b</span>}</span>,<span class="hljs-subst">#{<span class="hljs-property">@a</span>}</span>)"</span>

seen.Colors = {</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Creates a new <code>Color</code> using the supplied rgb and alpha values.</p>
<p>Each value must be in the range [0, 255] or, equivalently, [0x00, 0xFF].</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">rgb</span>: <span class="hljs-function"><span class="hljs-params">(r, g, b, a = <span class="hljs-number">255</span>)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Color(r, g, b, a)</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Creates a new <code>Color</code> using the supplied hex string of the form “#RRGGBB”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">hex</span>: <span class="hljs-function"><span class="hljs-params">(hex)</span> -&gt;</span>
    hex = hex.substring(<span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> (hex.charAt(<span class="hljs-number">0</span>) == <span class="hljs-string">'#'</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Color(
        parseInt(hex.substring(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>), <span class="hljs-number">16</span>),
        parseInt(hex.substring(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>), <span class="hljs-number">16</span>),
        parseInt(hex.substring(<span class="hljs-number">4</span>, <span class="hljs-number">6</span>), <span class="hljs-number">16</span>))</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Creates a new <code>Color</code> using the supplied hue, saturation, and lightness (HSL) values.</p>
<p>Each value must be in the range [0.0, 1.0].</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">hsl</span>: <span class="hljs-function"><span class="hljs-params">(h, s, l, a = <span class="hljs-number">1</span>)</span> -&gt;</span>
    r = g = b = <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> (s == <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>When saturation is 0, the color is “achromatic” or “grayscale”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      r = g = b = l
    <span class="hljs-keyword">else</span>
      <span class="hljs-function"><span class="hljs-title">hue2rgb</span> = <span class="hljs-params">(p, q, t)</span> -&gt;</span>
        <span class="hljs-keyword">if</span> (t &lt; <span class="hljs-number">0</span>)
          t += <span class="hljs-number">1</span>
         <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (t &gt; <span class="hljs-number">1</span>)
          t -= <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> (t &lt; <span class="hljs-number">1</span> / <span class="hljs-number">6</span>)
          <span class="hljs-keyword">return</span> p + (q - p) * <span class="hljs-number">6</span> * t
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (t &lt; <span class="hljs-number">1</span> / <span class="hljs-number">2</span>)
          <span class="hljs-keyword">return</span> q
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (t &lt; <span class="hljs-number">2</span> / <span class="hljs-number">3</span>)
          <span class="hljs-keyword">return</span> p + (q - p) * (<span class="hljs-number">2</span> / <span class="hljs-number">3</span> - t) * <span class="hljs-number">6</span>
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">return</span> p

      q = <span class="hljs-keyword">if</span> l &lt; <span class="hljs-number">0.5</span> <span class="hljs-keyword">then</span> l * (<span class="hljs-number">1</span> + s) <span class="hljs-keyword">else</span> l + s - l * s
      p = <span class="hljs-number">2</span> * l - q
      r = hue2rgb(p, q, h + <span class="hljs-number">1</span> / <span class="hljs-number">3</span>)
      g = hue2rgb(p, q, h)
      b = hue2rgb(p, q, h - <span class="hljs-number">1</span> / <span class="hljs-number">3</span>)

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Color(r * <span class="hljs-number">255</span>, g * <span class="hljs-number">255</span>, b * <span class="hljs-number">255</span>, a * <span class="hljs-number">255</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Generates a new random color for each surface of the supplied <code>Shape</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  randomSurfaces : <span class="hljs-function"><span class="hljs-params">(shape, sat = <span class="hljs-number">0.5</span>, lit = <span class="hljs-number">0.4</span>)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> surface <span class="hljs-keyword">in</span> shape.surfaces
      surface.fill = <span class="hljs-keyword">new</span> seen.Material seen.Colors.hsl(Math.random(), sat, lit)</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Generates a random hue then randomly drifts the hue for each surface of the supplied <code>Shape</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  randomSurfaces2 : <span class="hljs-function"><span class="hljs-params">(shape, drift = <span class="hljs-number">0.03</span>, sat = <span class="hljs-number">0.5</span>, lit = <span class="hljs-number">0.4</span>)</span> -&gt;</span>
    hue = Math.random()
    <span class="hljs-keyword">for</span> surface <span class="hljs-keyword">in</span> shape.surfaces
      hue += (Math.random() - <span class="hljs-number">0.5</span>) * drift
      <span class="hljs-keyword">if</span> hue &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> hue = <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> hue &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> hue = <span class="hljs-number">0</span>
      surface.fill = <span class="hljs-keyword">new</span> seen.Material seen.Colors.hsl(hue, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.4</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Generates a random color then sets the fill for every surface of the supplied <code>Shape</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  randomShape : <span class="hljs-function"><span class="hljs-params">(shape, sat = <span class="hljs-number">0.5</span>, lit = <span class="hljs-number">0.4</span>)</span> -&gt;</span>
    shape.fill <span class="hljs-keyword">new</span> seen.Material seen.Colors.hsl(Math.random(), sat, lit)</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>A few <code>Color</code>s are supplied for convenience.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  black :<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@hex</span>(<span class="hljs-string">'#000000'</span>)
  white :<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@hex</span>(<span class="hljs-string">'#FFFFFF'</span>)
  gray  :<span class="hljs-function"> -&gt;</span> <span class="hljs-property">@hex</span>(<span class="hljs-string">'#888888'</span>)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Convenience <code>Color</code> constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.<span class="hljs-function"><span class="hljs-title">C</span> = <span class="hljs-params">(r,g,b,a)</span> -&gt;</span> <span class="hljs-keyword">new</span> seen.Color(r,g,b,a)</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <h2 id="materials">Materials</h2>
<h4 id="colors-and-surface-material-properties-used-by-shaders-">Colors and surface material properties used by shaders.</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p><code>Material</code> objects hold the attributes that desribe the color and finish of a surface.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Material</span></span>
  defaults :</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>The base color of the material</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    color            : seen.Colors.gray()</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>The <code>metallic</code> attribute determines how the specular highlights are calculated. Normally, specular highlights are the color of the light source. If metallic is true, specular highlight colors are determined from the <code>specularColor</code> attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    metallic         : <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>The color used for specular highlights when <code>metallic</code> is true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    specularColor    : seen.Colors.white()</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>The <code>specularExponent</code> determines how “shiny” the material is. A low exponent will create a low-intesity, diffuse specular shine. A high exponent will create an intense, point-like specular shine.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    specularExponent : <span class="hljs-number">8</span></pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>A <code>Shader</code> object may be supplied to override the shader used for this material. For example, if you want to apply a flat color to text or other shapes, set this value to <code>seen.Shaders.Flat</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    shader           : <span class="hljs-literal">null</span>

  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@color</span>, options = {})</span> -&gt;</span>
    seen.Util.defaults(@, options, <span class="hljs-property">@defaults</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Apply the shader’s shading to this material, with the option to override the shader with the material’s shader (if defined).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render : <span class="hljs-function"><span class="hljs-params">(lights, shader, renderData)</span> -&gt;</span>
    renderShader = <span class="hljs-property">@shader</span> ? shader
    color = renderShader.shade(lights, renderData, @)
    color.a = <span class="hljs-property">@color</span>.a
    <span class="hljs-keyword">return</span> color</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <h2 id="lighting">Lighting</h2>
<h4 id="lights-and-various-shaders">Lights and various shaders</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>This model object holds the attributes and transformation of a light source.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Light</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Transformable</span></span>
  defaults :
    point     : seen.P()
    color     : seen.Colors.white()
    intensity : <span class="hljs-number">0.01</span>
    normal    : seen.P(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>).normalize()
    enabled   : <span class="hljs-literal">true</span>

  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@type</span>, options)</span> -&gt;</span>
    <span class="hljs-keyword">super</span>
    seen.Util.defaults(@, options, <span class="hljs-property">@defaults</span>)
    <span class="hljs-property">@id</span> = <span class="hljs-string">'l'</span> + seen.Util.uniqueId()

  render :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@colorIntensity</span> = <span class="hljs-property">@color</span>.copy().scale(<span class="hljs-property">@intensity</span>)

seen.Lights = {
  point       : <span class="hljs-function"><span class="hljs-params">(opts)</span> -&gt;</span> <span class="hljs-keyword">new</span> seen.Light <span class="hljs-string">'point'</span>, opts
  directional : <span class="hljs-function"><span class="hljs-params">(opts)</span> -&gt;</span> <span class="hljs-keyword">new</span> seen.Light <span class="hljs-string">'directional'</span>, opts
  ambient     : <span class="hljs-function"><span class="hljs-params">(opts)</span> -&gt;</span> <span class="hljs-keyword">new</span> seen.Light <span class="hljs-string">'ambient'</span>, opts
}</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <h2 id="shaders">Shaders</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Shader functions are aggregated in this utils object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.ShaderUtils = {
  applyDiffuse : <span class="hljs-function"><span class="hljs-params">(c, light, lightNormal, surfaceNormal, material)</span> -&gt;</span>
    dot = lightNormal.dot(surfaceNormal)

    <span class="hljs-keyword">if</span> (dot &gt; <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p>Apply diffuse phong shading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      c.addChannels(light.colorIntensity.copy().scale(dot))

  applyDiffuseAndSpecular : <span class="hljs-function"><span class="hljs-params">(c, light, lightNormal, surfaceNormal, material)</span> -&gt;</span>
    dot = lightNormal.dot(surfaceNormal)

    <span class="hljs-keyword">if</span> (dot &gt; <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Apply diffuse phong shading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      c.addChannels(light.colorIntensity.copy().scale(dot))</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>Compute and apply specular phong shading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      eyeNormal         = seen.Points.Z
      reflectionNormal  = surfaceNormal.copy().multiply(dot * <span class="hljs-number">2</span>).subtract(lightNormal)
      specularIntensity = Math.pow(<span class="hljs-number">1</span> + reflectionNormal.dot(eyeNormal), material.specularExponent)
      specularColor     = material.specularColor.copy().scale(specularIntensity * light.intensity / <span class="hljs-number">255.0</span>)
      c.addChannels(specularColor)

  applyAmbient : <span class="hljs-function"><span class="hljs-params">(c, light)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p>Apply ambient shading</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    c.addChannels(light.colorIntensity)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>The <code>Shader</code> class is the base class for all shader objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Shader</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>Every <code>Shader</code> implementation must override the <code>shade</code> method.</p>
<p><code>lights</code> is an object containing the ambient, point, and directional light sources.
<code>renderModel</code> is an instance of <code>RenderModel</code> and contains the transformed and projected surface data.
<code>material</code> is an instance of <code>Material</code> and contains the color and other attributes for determining how light reflects off the surface.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">shade</span>: <span class="hljs-function"><span class="hljs-params">(lights, renderModel, material)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>Override this</p>

            </div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>The <code>Phong</code> shader implements the Phong shading model with a diffuse, specular, and ambient term.</p>
<p>See <a href="https://en.wikipedia.org/wiki/Phong_reflection_model">https://en.wikipedia.org/wiki/Phong_reflection_model</a> for more information</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Phong</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Shader</span></span>
  <span class="hljs-attribute">shade</span>: <span class="hljs-function"><span class="hljs-params">(lights, renderModel, material)</span> -&gt;</span>
    c = <span class="hljs-keyword">new</span> seen.Color()

    <span class="hljs-keyword">for</span> light <span class="hljs-keyword">in</span> lights
      <span class="hljs-keyword">switch</span> light.type
        <span class="hljs-keyword">when</span> <span class="hljs-string">'point'</span>
          lightNormal = light.point.copy().subtract(renderModel.barycenter).normalize()
          seen.ShaderUtils.applyDiffuseAndSpecular(c, light, lightNormal, renderModel.normal, material)
        <span class="hljs-keyword">when</span> <span class="hljs-string">'directional'</span>
          seen.ShaderUtils.applyDiffuseAndSpecular(c, light, light.normal, renderModel.normal, material)
        <span class="hljs-keyword">when</span> <span class="hljs-string">'ambient'</span>
          seen.ShaderUtils.applyAmbient(c, light)

    c.multiplyChannels(material.color)

    <span class="hljs-keyword">if</span> material.metallic
      c.minChannels(material.specularColor)

    c.clamp(<span class="hljs-number">0</span>, <span class="hljs-number">0xFF</span>)
    <span class="hljs-keyword">return</span> c</pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>The <code>DiffusePhong</code> shader implements the Phong shading model with a diffuse and ambient term (no specular).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DiffusePhong</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Shader</span></span>
  <span class="hljs-attribute">shade</span>: <span class="hljs-function"><span class="hljs-params">(lights, renderModel, material)</span> -&gt;</span>
    c = <span class="hljs-keyword">new</span> seen.Color()

    <span class="hljs-keyword">for</span> light <span class="hljs-keyword">in</span> lights
      <span class="hljs-keyword">switch</span> light.type
        <span class="hljs-keyword">when</span> <span class="hljs-string">'point'</span>
          lightNormal = light.point.copy().subtract(renderModel.barycenter).normalize()
          seen.ShaderUtils.applyDiffuse(c, light, lightNormal, renderModel.normal, material)
        <span class="hljs-keyword">when</span> <span class="hljs-string">'directional'</span>
          seen.ShaderUtils.applyDiffuse(c, light, light.normal, renderModel.normal, material)
        <span class="hljs-keyword">when</span> <span class="hljs-string">'ambient'</span>
          seen.ShaderUtils.applyAmbient(c, light)

    c.multiplyChannels(material.color).clamp(<span class="hljs-number">0</span>, <span class="hljs-number">0xFF</span>)
    <span class="hljs-keyword">return</span> c</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>The <code>Ambient</code> shader colors surfaces from ambient light only.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Ambient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Shader</span></span>
  <span class="hljs-attribute">shade</span>: <span class="hljs-function"><span class="hljs-params">(lights, renderModel, material)</span> -&gt;</span>
    c = <span class="hljs-keyword">new</span> seen.Color()

    <span class="hljs-keyword">for</span> light <span class="hljs-keyword">in</span> lights
      <span class="hljs-keyword">switch</span> light.type
        <span class="hljs-keyword">when</span> <span class="hljs-string">'ambient'</span>
          seen.ShaderUtils.applyAmbient(c, light)

    c.multiplyChannels(material.color).clamp(<span class="hljs-number">0</span>, <span class="hljs-number">0xFF</span>)
    <span class="hljs-keyword">return</span> c</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>The <code>Flat</code> shader colors surfaces with the material color, disregarding all light sources.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Shader</span></span>
  <span class="hljs-attribute">shade</span>: <span class="hljs-function"><span class="hljs-params">(lights, renderModel, material)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> material.color</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>Since <code>Shader</code> objects are stateless, we don’t need to construct them more than once.
So, we export global instances here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.Shaders = {
  phong   : <span class="hljs-keyword">new</span> Phong()
  diffuse : <span class="hljs-keyword">new</span> DiffusePhong()
  ambient : <span class="hljs-keyword">new</span> Ambient()
  flat    : <span class="hljs-keyword">new</span> Flat()
}</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <h2 id="contexts">Contexts</h2>
<h4 id="base-classes-for-rendering-context-and-layers">Base classes for rendering context and layers</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>The <code>RenderContext</code> uses <code>RenderModel</code>s produced by the scene’s render method to paint the shapes into an HTML element.
Since we support both SVG and Canvas painters, the <code>RenderContext</code> and <code>RenderLayerContext</code> define a common interface.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderContext</span></span>
  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@layers</span> = {}

  <span class="hljs-attribute">render</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>
    <span class="hljs-property">@reset</span>()
    <span class="hljs-keyword">for</span> key, layer <span class="hljs-keyword">of</span> <span class="hljs-property">@layers</span>
      layer.context.reset()
      layer.layer.render(layer.context)
      layer.context.cleanup()
    <span class="hljs-property">@cleanup</span>()
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>Returns a new <code>Animator</code> with this context’s render method pre-registered.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  animate :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Animator().onRender(<span class="hljs-property">@render</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>Add a new <code>RenderLayerContext</code> to this context. This allows us to easily stack paintable components such as
a fill backdrop, or even multiple scenes in one context.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">layer</span>: <span class="hljs-function"><span class="hljs-params">(name, layer)</span> -&gt;</span>
    <span class="hljs-property">@layers</span>[name] = {
      layer   : layer
      context : @
    }
    <span class="hljs-keyword">return</span> @

  reset   :<span class="hljs-function"> -&gt;</span>
  cleanup :<span class="hljs-function"> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>The <code>RenderLayerContext</code> defines the interface for producing painters that can paint various things into the current layer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderLayerContext</span></span>
  path    :<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># Return a path painter</span>
  rect    :<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># Return a rect painter</span>
  circle  :<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># Return a circle painter</span>
  text    :<span class="hljs-function"> -&gt;</span> <span class="hljs-comment"># Return a text painter</span>
  
  reset   :<span class="hljs-function"> -&gt;</span>
  cleanup :<span class="hljs-function"> -&gt;</span>

seen.Contexts = {
  create : <span class="hljs-function"><span class="hljs-params">(elementId, width, height)</span> -&gt;</span>
    tag = seen.Util.element(elementId)?.tagName.toUpperCase()
    <span class="hljs-keyword">switch</span> tag
      <span class="hljs-keyword">when</span> <span class="hljs-string">'SVG'</span>    <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.SvgRenderContext(elementId, width, height)
      <span class="hljs-keyword">when</span> <span class="hljs-string">'CANVAS'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.CanvasRenderContext(elementId, width, height)
  
  createWithScene : <span class="hljs-function"><span class="hljs-params">(elementId, scene, width, height)</span> -&gt;</span>
    context = seen.Contexts.create(elementId, width, height)
    seen.LayersScene(context, scene, width, height)
    <span class="hljs-keyword">return</span> context
}</pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <h2 id="painters">Painters</h2>
<h4 id="defines-the-methods-of-painting-a-surface-">Defines the methods of painting a surface.</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>Each <code>Painter</code> overrides the paint method. It uses the supplied <code>RenderLayerContext</code>‘s builders
to create and style the geometry on screen.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Painter</span></span>
  paint : <span class="hljs-function"><span class="hljs-params">(renderModel, context)</span> -&gt;</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PathPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Painter</span></span>
  paint : <span class="hljs-function"><span class="hljs-params">(renderModel, context)</span> -&gt;</span>
    painter = context.path().path(renderModel.projected.points)

    <span class="hljs-keyword">if</span> renderModel.fill?
      painter.fill(
        fill           : <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> renderModel.fill? <span class="hljs-keyword">then</span> <span class="hljs-string">'none'</span> <span class="hljs-keyword">else</span> renderModel.fill.hex()
        <span class="hljs-string">'fill-opacity'</span> : <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> renderModel.fill?.a? <span class="hljs-keyword">then</span> <span class="hljs-number">1.0</span> <span class="hljs-keyword">else</span> (renderModel.fill.a / <span class="hljs-number">255.0</span>)
      )

    <span class="hljs-keyword">if</span> renderModel.stroke?
      painter.draw(
        fill           : <span class="hljs-string">'none'</span>
        stroke         : <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> renderModel.stroke? <span class="hljs-keyword">then</span> <span class="hljs-string">'none'</span> <span class="hljs-keyword">else</span> renderModel.stroke.hex()
        <span class="hljs-string">'stroke-width'</span> : renderModel.surface[<span class="hljs-string">'stroke-width'</span>] ? <span class="hljs-number">1</span>
      )

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TextPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Painter</span></span>
  paint : <span class="hljs-function"><span class="hljs-params">(renderModel, context)</span> -&gt;</span>
    xform = renderModel.transform.copy().multiply renderModel.projection
    style = {
      fill          : <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> renderModel.fill? <span class="hljs-keyword">then</span> <span class="hljs-string">'none'</span> <span class="hljs-keyword">else</span> renderModel.fill.hex()
      <span class="hljs-string">'text-anchor'</span> : renderModel.surface.anchor ? <span class="hljs-string">'middle'</span>
    }
    context.text().fillText(xform, renderModel.surface.text, style)

seen.Painters = {
  path  : <span class="hljs-keyword">new</span> PathPainter()
  text  : <span class="hljs-keyword">new</span> TextPainter()
}</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <h2 id="rendermodels">RenderModels</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>The <code>RenderModel</code> object contains the transformed and projected points as well as various data
needed to shade and paint a <code>Surface</code>.</p>
<p>Once initialized, the object will have a constant memory footprint
down to <code>Number</code> primitives. Also, we compare each transform and projection
to prevent unnecessary re-computation. </p>
<p>If you need to force a re-computation, mark the surface as ‘dirty’.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderModel</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@surface</span>, <span class="hljs-property">@transform</span>, <span class="hljs-property">@projection</span>)</span> -&gt;</span>
    <span class="hljs-property">@points</span>      = <span class="hljs-property">@surface</span>.points
    <span class="hljs-property">@transformed</span> = <span class="hljs-property">@_initRenderData</span>()
    <span class="hljs-property">@projected</span>   = <span class="hljs-property">@_initRenderData</span>()
    <span class="hljs-property">@_update</span>()

  <span class="hljs-attribute">update</span>: <span class="hljs-function"><span class="hljs-params">(transform, projection)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@surface</span>.dirty <span class="hljs-keyword">and</span> seen.Util.arraysEqual(transform.m, <span class="hljs-property">@transform</span>.m) <span class="hljs-keyword">and</span> seen.Util.arraysEqual(projection.m, <span class="hljs-property">@projection</span>.m)
      <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-property">@transform</span>  = transform
      <span class="hljs-property">@projection</span> = projection
      <span class="hljs-property">@_update</span>()

  <span class="hljs-attribute">_update</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@_math</span>(<span class="hljs-property">@transformed</span>, <span class="hljs-property">@points</span>, <span class="hljs-property">@transform</span>, <span class="hljs-literal">false</span>)
    <span class="hljs-property">@_math</span>(<span class="hljs-property">@projected</span>, <span class="hljs-property">@transformed</span>.points, <span class="hljs-property">@projection</span>, <span class="hljs-literal">true</span>)
    <span class="hljs-property">@surface</span>.dirty = <span class="hljs-literal">false</span>

  <span class="hljs-attribute">_initRenderData</span>:<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">return</span> {
      points     : (p.copy() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> <span class="hljs-property">@points</span>)
      barycenter : seen.P()
      normal     : seen.P()
      v0         : seen.P()
      v1         : seen.P()
    }

  <span class="hljs-attribute">_math</span>: <span class="hljs-function"><span class="hljs-params">(set, points, transform, applyClip = <span class="hljs-literal">false</span>)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>Apply transform to points</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> p,i <span class="hljs-keyword">in</span> points
      sp = set.points[i]
      sp.set(p).transform(transform)</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>Applying the clip is what ultimately scales the x and y coordinates in a perpsective projection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> applyClip <span class="hljs-keyword">then</span> sp.divide(sp.w)</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>Compute barycenter, which is used in aligning shapes in the painters algorithm</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    set.barycenter.set(seen.Points.ZERO)
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> set.points
      set.barycenter.add(p)
    set.barycenter.divide(set.points.length)</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>Compute normal, which is used for backface culling (when enabled)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> set.points.length &lt; <span class="hljs-number">2</span>
      set.v0.set(seen.Points.Z)
      set.v1.set(seen.Points.Z)
      set.normal.set(seen.Points.Z)
    <span class="hljs-keyword">else</span>
      set.v0.set(set.points[<span class="hljs-number">1</span>]).subtract(set.points[<span class="hljs-number">0</span>])
      set.v1.set(set.points[points.length - <span class="hljs-number">1</span>]).subtract(set.points[<span class="hljs-number">0</span>])
      set.normal.set(set.v0).cross(set.v1).normalize()</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>The <code>LightRenderModel</code> stores pre-computed values necessary for shading surfaces with the supplied <code>Light</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">LightRenderModel</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(light, transform)</span> -&gt;</span>
    <span class="hljs-property">@colorIntensity</span> = light.color.copy().scale(light.intensity)
    <span class="hljs-property">@type</span>           = light.type
    <span class="hljs-property">@intensity</span>      = light.intensity
    <span class="hljs-property">@point</span>          = light.point.copy().transform(transform)
    origin          = seen.Points.ZERO.copy().transform(transform)
    <span class="hljs-property">@normal</span>         = light.normal.copy().transform(transform).subtract(origin).normalize()




<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderLayer</span></span>
  <span class="hljs-attribute">render</span>: <span class="hljs-function"><span class="hljs-params">(context)</span> =&gt;</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">FillLayer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderLayer</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@width</span> = <span class="hljs-number">500</span>, <span class="hljs-property">@height</span> = <span class="hljs-number">500</span>, <span class="hljs-property">@fill</span> = <span class="hljs-string">'#EEE'</span>)</span> -&gt;</span>

  <span class="hljs-attribute">render</span>: <span class="hljs-function"><span class="hljs-params">(context)</span> =&gt;</span>
    context.rect()
      .rect(<span class="hljs-property">@width</span>, <span class="hljs-property">@height</span>)
      .fill(fill : <span class="hljs-property">@fill</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SceneLayer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderLayer</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@scene</span>)</span> -&gt;</span>

  render : <span class="hljs-function"><span class="hljs-params">(context)</span> =&gt;</span>
    <span class="hljs-keyword">for</span> renderModel <span class="hljs-keyword">in</span> <span class="hljs-property">@scene</span>.render()
      renderModel.surface.painter.paint(renderModel, context)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">DebugLayer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderLayer</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(animator)</span> -&gt;</span>
    <span class="hljs-property">@_msg</span> = <span class="hljs-string">''</span>
    <span class="hljs-property">@_fps</span> = <span class="hljs-number">30</span>

    animator.onBefore <span class="hljs-property">@_renderStart</span>
    animator.onAfter <span class="hljs-property">@_renderEnd</span>

  render : <span class="hljs-function"><span class="hljs-params">(context)</span> =&gt;</span>
    context.text()
      .fillText(seen.M().translate(<span class="hljs-number">10</span> , <span class="hljs-number">20</span>).scale(<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>,<span class="hljs-number">1</span>), <span class="hljs-property">@_msg</span>, {fill : <span class="hljs-string">'#000'</span>})

  <span class="hljs-attribute">_renderStart</span>:<span class="hljs-function"> =&gt;</span>
    <span class="hljs-property">@_renderStartTime</span> = <span class="hljs-keyword">new</span> Date()

  <span class="hljs-attribute">_renderEnd</span>:<span class="hljs-function"> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>Compute frame time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    frameTime = <span class="hljs-number">1000</span> / (<span class="hljs-keyword">new</span> Date() - <span class="hljs-property">@_renderStartTime</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>Smooth frame time</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> frameTime != NaN <span class="hljs-keyword">then</span> <span class="hljs-property">@_fps</span> += (frameTime - <span class="hljs-property">@_fps</span>) / <span class="hljs-number">20</span></pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>Record debug message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@_msg</span> = <span class="hljs-string">"fps: <span class="hljs-subst">#{<span class="hljs-property">@_fps</span>.toFixed(<span class="hljs-number">1</span>)}</span>"</span> <span class="hljs-comment">#" surfaces: #{e.length}"</span>


seen.<span class="hljs-function"><span class="hljs-title">LayersScene</span> = <span class="hljs-params">(context, scene, width = <span class="hljs-number">400</span>, height = <span class="hljs-number">400</span>)</span> -&gt;</span>
  context
    .layer(<span class="hljs-string">'background'</span>, <span class="hljs-keyword">new</span> seen.FillLayer(width, height))
    .layer(<span class="hljs-string">'scene'</span>,      <span class="hljs-keyword">new</span> seen.SceneLayer(scene))
  <span class="hljs-keyword">return</span> context


<span class="hljs-function"><span class="hljs-title">_svg</span> = <span class="hljs-params">(name)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">document</span>.createElementNS(<span class="hljs-string">'http://www.w3.org/2000/svg'</span>, name)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SvgStyler</span></span>
  _attributes : {}
  _svgTag     : <span class="hljs-string">'g'</span>

  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@elementFactory</span>)</span> -&gt;</span>

  clear : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@_attributes</span> = {}
    <span class="hljs-keyword">return</span> @

  fill : <span class="hljs-function"><span class="hljs-params">(style = {})</span> -&gt;</span>
    <span class="hljs-property">@_paint</span>(style)
    <span class="hljs-keyword">return</span> @

  draw : <span class="hljs-function"><span class="hljs-params">(style = {})</span> -&gt;</span>
    <span class="hljs-property">@_paint</span>(style)
    <span class="hljs-keyword">return</span> @

  _paint : <span class="hljs-function"><span class="hljs-params">(style)</span> -&gt;</span>
    el = <span class="hljs-property">@elementFactory</span>(<span class="hljs-property">@_svgTag</span>)

    str = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> style
      str += <span class="hljs-string">"<span class="hljs-subst">#{key}</span>:<span class="hljs-subst">#{value}</span>;"</span>
    el.setAttribute(<span class="hljs-string">'style'</span>, str)

    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> <span class="hljs-property">@_attributes</span>
      el.setAttribute(key, value)
    <span class="hljs-keyword">return</span> el

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SvgPathPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SvgStyler</span></span>
  _svgTag : <span class="hljs-string">'path'</span>

  path : <span class="hljs-function"><span class="hljs-params">(points)</span> -&gt;</span>
    <span class="hljs-property">@_attributes</span>.d = <span class="hljs-string">'M'</span> + points.map<span class="hljs-function"><span class="hljs-params">((p) -&gt; <span class="hljs-string">"<span class="hljs-subst">#{p.x}</span> <span class="hljs-subst">#{p.y}</span>"</span>)</span>.<span class="hljs-title">join</span> '<span class="hljs-title">L</span>'
    <span class="hljs-title">return</span> @

<span class="hljs-title">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SvgTextPainter</span>
  <span class="hljs-title">_svgTag</span>      : '<span class="hljs-title">text</span>'

  <span class="hljs-title">constructor</span> : <span class="hljs-params">(<span class="hljs-property">@elementFactory</span>)</span> -&gt;</span>

  fillText : <span class="hljs-function"><span class="hljs-params">(transform, text, style = {})</span> -&gt;</span>
    el = <span class="hljs-property">@elementFactory</span>(<span class="hljs-property">@_svgTag</span>)

    m = seen.Matrices.flipY().multiply(transform).m

    el.setAttribute(<span class="hljs-string">'transform'</span>, <span class="hljs-string">"matrix(<span class="hljs-subst">#{m[<span class="hljs-number">0</span>]}</span> <span class="hljs-subst">#{m[<span class="hljs-number">4</span>]}</span> <span class="hljs-subst">#{m[<span class="hljs-number">1</span>]}</span> <span class="hljs-subst">#{m[<span class="hljs-number">5</span>]}</span> <span class="hljs-subst">#{m[<span class="hljs-number">3</span>]}</span> <span class="hljs-subst">#{m[<span class="hljs-number">7</span>]}</span>)"</span>)
    el.setAttribute(<span class="hljs-string">'font-family'</span>, <span class="hljs-string">'Roboto'</span>)

    str = <span class="hljs-string">''</span>
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">of</span> style
      str += <span class="hljs-string">"<span class="hljs-subst">#{key}</span>:<span class="hljs-subst">#{value}</span>;"</span>
    el.setAttribute(<span class="hljs-string">'style'</span>, str)

    el.textContent = text


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SvgRectPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SvgStyler</span></span>
  _svgTag : <span class="hljs-string">'rect'</span>

  rect : <span class="hljs-function"><span class="hljs-params">(width, height)</span> -&gt;</span>
    <span class="hljs-property">@_attributes</span>.width  = width
    <span class="hljs-property">@_attributes</span>.height = height
    <span class="hljs-keyword">return</span> @

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SvgCirclePainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SvgStyler</span></span>
  _svgTag : <span class="hljs-string">'circle'</span>

  <span class="hljs-attribute">circle</span>: <span class="hljs-function"><span class="hljs-params">(center, radius)</span> -&gt;</span>
    <span class="hljs-property">@_attributes</span>.cx = center.x
    <span class="hljs-property">@_attributes</span>.cy = center.y
    <span class="hljs-property">@_attributes</span>.r  = radius
    <span class="hljs-keyword">return</span> @

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SvgLayerRenderContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderLayerContext</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@group</span>)</span> -&gt;</span>
    <span class="hljs-property">@pathPainter</span>   = <span class="hljs-keyword">new</span> seen.SvgPathPainter(<span class="hljs-property">@_elementFactory</span>)
    <span class="hljs-property">@textPainter</span>   = <span class="hljs-keyword">new</span> seen.SvgTextPainter(<span class="hljs-property">@_elementFactory</span>)
    <span class="hljs-property">@circlePainter</span> = <span class="hljs-keyword">new</span> seen.SvgCirclePainter(<span class="hljs-property">@_elementFactory</span>)
    <span class="hljs-property">@rectPainter</span>   = <span class="hljs-keyword">new</span> seen.SvgRectPainter(<span class="hljs-property">@_elementFactory</span>)
    <span class="hljs-property">@_i</span> = <span class="hljs-number">0</span>

  path   : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-property">@pathPainter</span>.clear()
  rect   : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-property">@rectPainter</span>.clear()
  circle : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-property">@circlePainter</span>.clear()
  text   : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-property">@textPainter</span>

  reset :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@_i</span> = <span class="hljs-number">0</span>

  cleanup :<span class="hljs-function"> -&gt;</span>
    children = <span class="hljs-property">@group</span>.childNodes
    <span class="hljs-keyword">while</span> (<span class="hljs-property">@_i</span> &lt; children.length)
      children[<span class="hljs-property">@_i</span>].setAttribute(<span class="hljs-string">'style'</span>, <span class="hljs-string">'display: none;'</span>)
      <span class="hljs-property">@_i</span>++

  _elementFactory : <span class="hljs-function"><span class="hljs-params">(type)</span> =&gt;</span>
    children = <span class="hljs-property">@group</span>.childNodes
    <span class="hljs-keyword">if</span> <span class="hljs-property">@_i</span> &gt;= children.length
      path = _svg(type)
      <span class="hljs-property">@group</span>.appendChild(path)
      <span class="hljs-property">@_i</span>++
      <span class="hljs-keyword">return</span> path

    current = children[<span class="hljs-property">@_i</span>]
    <span class="hljs-keyword">if</span> current.tagName <span class="hljs-keyword">is</span> type
      <span class="hljs-property">@_i</span>++
      <span class="hljs-keyword">return</span> current
    <span class="hljs-keyword">else</span>
      path = _svg(type)
      <span class="hljs-property">@group</span>.replaceChild(path, current)
      <span class="hljs-property">@_i</span>++
      <span class="hljs-keyword">return</span> path

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">SvgRenderContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderContext</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@svg</span>)</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@svg</span> = seen.Util.element(<span class="hljs-property">@svg</span>)

  layer : <span class="hljs-function"><span class="hljs-params">(name, layer)</span> -&gt;</span>
    <span class="hljs-property">@svg</span>.appendChild(group = _svg(<span class="hljs-string">'g'</span>))
    <span class="hljs-property">@layers</span>[name] = {
      layer   : layer
      context : <span class="hljs-keyword">new</span> seen.SvgLayerRenderContext(group)
    }
    <span class="hljs-keyword">return</span> @

seen.<span class="hljs-function"><span class="hljs-title">SvgContext</span> = <span class="hljs-params">(elementId, scene, width, height)</span> -&gt;</span>
  context = <span class="hljs-keyword">new</span> seen.SvgRenderContext(elementId)
  <span class="hljs-keyword">return</span> seen.LayersScene(context, scene, width, height)


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">CanvasStyler</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@ctx</span>)</span> -&gt;</span>

  draw : <span class="hljs-function"><span class="hljs-params">(style = {})</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>Copy over SVG CSS attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> style.stroke? <span class="hljs-keyword">then</span> <span class="hljs-property">@ctx</span>.strokeStyle = style.stroke
    <span class="hljs-keyword">if</span> style[<span class="hljs-string">'stroke-width'</span>]? <span class="hljs-keyword">then</span> <span class="hljs-property">@ctx</span>.lineWidth = style[<span class="hljs-string">'stroke-width'</span>]
    <span class="hljs-keyword">if</span> style[<span class="hljs-string">'text-anchor'</span>]? <span class="hljs-keyword">then</span> <span class="hljs-property">@ctx</span>.textAlign = style[<span class="hljs-string">'text-anchor'</span>]

    <span class="hljs-property">@ctx</span>.stroke()
    <span class="hljs-keyword">return</span> @

  fill : <span class="hljs-function"><span class="hljs-params">(style = {})</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>Copy over SVG CSS attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> style.fill? <span class="hljs-keyword">then</span> <span class="hljs-property">@ctx</span>.fillStyle = style.fill
    <span class="hljs-keyword">if</span> style[<span class="hljs-string">'text-anchor'</span>]? <span class="hljs-keyword">then</span> <span class="hljs-property">@ctx</span>.textAlign = style[<span class="hljs-string">'text-anchor'</span>]

    <span class="hljs-property">@ctx</span>.fill()
    <span class="hljs-keyword">return</span> @

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">CanvasPathPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">CanvasStyler</span></span>
  <span class="hljs-attribute">path</span>: <span class="hljs-function"><span class="hljs-params">(points)</span> -&gt;</span>
    <span class="hljs-property">@ctx</span>.beginPath()

    <span class="hljs-keyword">for</span> p, i <span class="hljs-keyword">in</span> points
      <span class="hljs-keyword">if</span> i <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
        <span class="hljs-property">@ctx</span>.moveTo(p.x, p.y)
      <span class="hljs-keyword">else</span>
        <span class="hljs-property">@ctx</span>.lineTo(p.x, p.y)

    <span class="hljs-property">@ctx</span>.closePath()
    <span class="hljs-keyword">return</span> @

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">CanvasRectPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">CanvasStyler</span></span>
  <span class="hljs-attribute">rect</span>: <span class="hljs-function"><span class="hljs-params">(width, height)</span> -&gt;</span>
    <span class="hljs-property">@ctx</span>.rect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height)
    <span class="hljs-keyword">return</span> @

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">CanvasCirclePainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">CanvasStyler</span></span>
  <span class="hljs-attribute">circle</span>: <span class="hljs-function"><span class="hljs-params">(center, radius)</span> -&gt;</span>
    <span class="hljs-property">@ctx</span>.beginPath()
    <span class="hljs-property">@ctx</span>.arc(center.x, center.y, radius, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>*Math.PI, <span class="hljs-literal">true</span>)
    <span class="hljs-keyword">return</span> @

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">CanvasTextPainter</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@ctx</span>)</span> -&gt;</span>

  fillText : <span class="hljs-function"><span class="hljs-params">(transform, text, style = {})</span> -&gt;</span>
    m = seen.Matrices.flipY().multiply(transform).m
    <span class="hljs-property">@ctx</span>.save()
    <span class="hljs-property">@ctx</span>.font = <span class="hljs-string">'16px Roboto'</span> <span class="hljs-comment"># TODO method</span>
    <span class="hljs-property">@ctx</span>.setTransform(m[<span class="hljs-number">0</span>], m[<span class="hljs-number">4</span>], m[<span class="hljs-number">1</span>], m[<span class="hljs-number">5</span>], m[<span class="hljs-number">3</span>], m[<span class="hljs-number">7</span>])

    <span class="hljs-keyword">if</span> style.fill? <span class="hljs-keyword">then</span> <span class="hljs-property">@ctx</span>.fillStyle = style.fill
    <span class="hljs-keyword">if</span> style[<span class="hljs-string">'text-anchor'</span>]? <span class="hljs-keyword">then</span> <span class="hljs-property">@ctx</span>.textAlign = style[<span class="hljs-string">'text-anchor'</span>]

    <span class="hljs-property">@ctx</span>.fillText(text, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
    <span class="hljs-property">@ctx</span>.restore()
    <span class="hljs-keyword">return</span> @

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">CanvasLayerRenderContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderLayerContext</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@ctx</span>)</span> -&gt;</span>
    <span class="hljs-property">@pathPainter</span>  = <span class="hljs-keyword">new</span> seen.CanvasPathPainter(<span class="hljs-property">@ctx</span>)
    <span class="hljs-property">@ciclePainter</span> = <span class="hljs-keyword">new</span> seen.CanvasCirclePainter(<span class="hljs-property">@ctx</span>)
    <span class="hljs-property">@textPainter</span>  = <span class="hljs-keyword">new</span> seen.CanvasTextPainter(<span class="hljs-property">@ctx</span>)
    <span class="hljs-property">@rectPainter</span>  = <span class="hljs-keyword">new</span> seen.CanvasRectPainter(<span class="hljs-property">@ctx</span>)
  
  path   : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-property">@pathPainter</span>
  rect   : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-property">@rectPainter</span>
  circle : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-property">@ciclePainter</span>
  text   : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-property">@textPainter</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">CanvasRenderContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">RenderContext</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@el</span>, <span class="hljs-property">@width</span>, <span class="hljs-property">@height</span>)</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@el</span>  = seen.Util.element(<span class="hljs-property">@el</span>)
    <span class="hljs-property">@ctx</span> = <span class="hljs-property">@el</span>.getContext(<span class="hljs-string">'2d'</span>)

  layer : <span class="hljs-function"><span class="hljs-params">(name, layer)</span> -&gt;</span>
    <span class="hljs-property">@layers</span>[name] = {
      layer   : layer
      context : <span class="hljs-keyword">new</span> seen.CanvasLayerRenderContext(<span class="hljs-property">@ctx</span>)
    }
    <span class="hljs-keyword">return</span> @

  reset :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@ctx</span>.clearRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-property">@width</span>, <span class="hljs-property">@height</span>)


seen.<span class="hljs-function"><span class="hljs-title">CanvasContext</span> = <span class="hljs-params">(elementId, scene, width, height)</span> -&gt;</span>
  context = <span class="hljs-keyword">new</span> seen.CanvasRenderContext(elementId, width, height)
  <span class="hljs-keyword">return</span> seen.LayersScene(context, scene, width, height)</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <h2 id="interaction">Interaction</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>A global window event dispatcher.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.WindowEvents = <span class="hljs-keyword">do</span><span class="hljs-function"> -&gt;</span>
  dispatch = seen.Events.dispatch(<span class="hljs-string">'mouseMove'</span>, <span class="hljs-string">'mouseDown'</span>, <span class="hljs-string">'mouseUp'</span>)
  <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'mouseup'</span>, dispatch.mouseUp, <span class="hljs-literal">true</span>)
  <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'mousedown'</span>, dispatch.mouseDown, <span class="hljs-literal">true</span>)
  <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'mousemove'</span>, dispatch.mouseMove, <span class="hljs-literal">true</span>)
  <span class="hljs-keyword">return</span> {<span class="hljs-literal">on</span> : dispatch.<span class="hljs-literal">on</span>}</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>An event dispatcher for mouse and drag events on a single dom element.
The available events are ‘dragStart’, ‘drag’, ‘dragEnd’, ‘mouseMove’, ‘mouseDown’, ‘mouseUp’</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">MouseEvents</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@el</span>, options)</span> -&gt;</span>
    seen.Util.defaults(@, options, <span class="hljs-property">@defaults</span>)

    <span class="hljs-property">@_uid</span> = seen.Util.uniqueId(<span class="hljs-string">'mouser-'</span>)

    <span class="hljs-property">@dispatch</span> = seen.Events.dispatch(<span class="hljs-string">'dragStart'</span>, <span class="hljs-string">'drag'</span>, <span class="hljs-string">'dragEnd'</span>, <span class="hljs-string">'mouseMove'</span>, <span class="hljs-string">'mouseDown'</span>, <span class="hljs-string">'mouseUp'</span>, <span class="hljs-string">'mouseWheel'</span>)
    <span class="hljs-property">@on</span>       = <span class="hljs-property">@dispatch</span>.<span class="hljs-literal">on</span>

    <span class="hljs-property">@_mouseDown</span> = <span class="hljs-literal">false</span>
    <span class="hljs-property">@attach</span>()

  attach : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@el</span>.addEventListener(<span class="hljs-string">'mousedown'</span>, <span class="hljs-property">@_onMouseDown</span>)
    <span class="hljs-property">@el</span>.addEventListener(<span class="hljs-string">'mousewheel'</span>, <span class="hljs-property">@_onMouseWheel</span>)

  detach : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@el</span>.removeEventListener(<span class="hljs-string">'mousedown'</span>, <span class="hljs-property">@_onMouseDown</span>)
    <span class="hljs-property">@el</span>.removeEventListener(<span class="hljs-string">'mousewheel'</span>, <span class="hljs-property">@_onMouseWheel</span>)

  _onMouseMove : <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    <span class="hljs-property">@dispatch</span>.mouseMove(e)
    <span class="hljs-keyword">if</span> <span class="hljs-property">@_mouseDown</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@dispatch</span>.drag(e)

  _onMouseDown : <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    <span class="hljs-property">@_mouseDown</span> = <span class="hljs-literal">true</span>
    seen.WindowEvents.<span class="hljs-literal">on</span> <span class="hljs-string">"mouseUp.<span class="hljs-subst">#{<span class="hljs-property">@_uid</span>}</span>"</span>, <span class="hljs-property">@_onMouseUp</span>
    seen.WindowEvents.<span class="hljs-literal">on</span> <span class="hljs-string">"mouseMove.<span class="hljs-subst">#{<span class="hljs-property">@_uid</span>}</span>"</span>, <span class="hljs-property">@_onMouseMove</span>
    <span class="hljs-property">@dispatch</span>.mouseDown(e)
    <span class="hljs-property">@dispatch</span>.dragStart(e)

  _onMouseUp : <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    <span class="hljs-property">@_mouseDown</span> = <span class="hljs-literal">false</span>
    seen.WindowEvents.<span class="hljs-literal">on</span> <span class="hljs-string">"mouseUp.<span class="hljs-subst">#{<span class="hljs-property">@_uid</span>}</span>"</span>, <span class="hljs-literal">null</span>
    seen.WindowEvents.<span class="hljs-literal">on</span> <span class="hljs-string">"mouseMove.<span class="hljs-subst">#{<span class="hljs-property">@_uid</span>}</span>"</span>, <span class="hljs-literal">null</span>
    <span class="hljs-property">@dispatch</span>.mouseUp(e)
    <span class="hljs-property">@dispatch</span>.dragEnd(e)

  _onMouseWheel : <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    <span class="hljs-property">@dispatch</span>.mouseWheel(e)</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>A class for computing mouse interia for interial scrolling</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">InertialMouse</span></span>
  <span class="hljs-property">@inertiaExtinction</span> : <span class="hljs-number">0.1</span>
  <span class="hljs-property">@smoothingTimeout</span>  : <span class="hljs-number">300</span>
  <span class="hljs-property">@inertiaMsecDelay</span>  : <span class="hljs-number">30</span>

  constructor :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@reset</span>()

  get :<span class="hljs-function"> -&gt;</span>
    scale = <span class="hljs-number">1000</span> / seen.InertialMouse.inertiaMsecDelay
    <span class="hljs-keyword">return</span> [<span class="hljs-property">@x</span> * scale, <span class="hljs-property">@y</span> * scale]

  reset :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@xy</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]
    <span class="hljs-keyword">return</span> @

  update : <span class="hljs-function"><span class="hljs-params">(xy)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@lastUpdate</span>?
      msec = <span class="hljs-keyword">new</span> Date().getTime() - <span class="hljs-property">@lastUpdate</span>.getTime()</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>Compute pixels per milliseconds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      xy = xy.map <span class="hljs-function"><span class="hljs-params">(x)</span> -&gt;</span> x / Math.max(msec, <span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>Compute interpolation parameter based on time between measurements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      t = Math.min(<span class="hljs-number">1</span>, msec / seen.InertialMouse.smoothingTimeout)
      <span class="hljs-property">@x</span> = t * xy[<span class="hljs-number">0</span>] + (<span class="hljs-number">1.0</span> - t) * <span class="hljs-property">@x</span>
      <span class="hljs-property">@y</span> = t * xy[<span class="hljs-number">1</span>] + (<span class="hljs-number">1.0</span> - t) * <span class="hljs-property">@y</span>
    <span class="hljs-keyword">else</span>
     [<span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>] = xy

    <span class="hljs-property">@lastUpdate</span> = <span class="hljs-keyword">new</span> Date()
    <span class="hljs-keyword">return</span> @

  damp :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@x</span> *= (<span class="hljs-number">1.0</span> - seen.InertialMouse.inertiaExtinction)
    <span class="hljs-property">@y</span> *= (<span class="hljs-number">1.0</span> - seen.InertialMouse.inertiaExtinction)
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>A class that adds simple mouse dragging to a dom element.
A ‘drag’ event is emitted as the user is dragging their mouse.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Drag</span></span>
  <span class="hljs-attribute">defaults</span>:
    inertia : <span class="hljs-literal">false</span>

  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@el</span>, options)</span> -&gt;</span>
    seen.Util.defaults(@, options, <span class="hljs-property">@defaults</span>)
    <span class="hljs-property">@el</span> = seen.Util.element(<span class="hljs-property">@el</span>)
    <span class="hljs-property">@_uid</span> = seen.Util.uniqueId(<span class="hljs-string">'dragger-'</span>)

    <span class="hljs-property">@_inertiaRunning</span> = <span class="hljs-literal">false</span>
    <span class="hljs-property">@_dragState</span> =
      dragging : <span class="hljs-literal">false</span>
      origin   : <span class="hljs-literal">null</span>
      last     : <span class="hljs-literal">null</span>
      inertia  : <span class="hljs-keyword">new</span> seen.InertialMouse()

    <span class="hljs-property">@dispatch</span> = seen.Events.dispatch(<span class="hljs-string">'drag'</span>)
    <span class="hljs-property">@on</span>       = <span class="hljs-property">@dispatch</span>.<span class="hljs-literal">on</span>

    mouser = <span class="hljs-keyword">new</span> seen.MouseEvents(<span class="hljs-property">@el</span>)
    mouser.<span class="hljs-literal">on</span> <span class="hljs-string">"dragStart.<span class="hljs-subst">#{<span class="hljs-property">@_uid</span>}</span>"</span>, <span class="hljs-property">@_onDragStart</span>
    mouser.<span class="hljs-literal">on</span> <span class="hljs-string">"dragEnd.<span class="hljs-subst">#{<span class="hljs-property">@_uid</span>}</span>"</span>, <span class="hljs-property">@_onDragEnd</span>
    mouser.<span class="hljs-literal">on</span> <span class="hljs-string">"drag.<span class="hljs-subst">#{<span class="hljs-property">@_uid</span>}</span>"</span>, <span class="hljs-property">@_onDrag</span>

  _onDragStart : <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    <span class="hljs-property">@_stopInertia</span>()
    <span class="hljs-property">@_dragState</span>.dragging = <span class="hljs-literal">true</span>
    <span class="hljs-property">@_dragState</span>.origin = [e.pageX, e.pageY]
    <span class="hljs-property">@_dragState</span>.last   = [e.pageX, e.pageY]

  _onDragEnd : <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    <span class="hljs-property">@_dragState</span>.dragging = <span class="hljs-literal">false</span>

    <span class="hljs-keyword">if</span> <span class="hljs-property">@inertia</span>
      dragEvent =
        offset         : [e.pageX - <span class="hljs-property">@_dragState</span>.origin[<span class="hljs-number">0</span>], e.pageY - <span class="hljs-property">@_dragState</span>.origin[<span class="hljs-number">1</span>]]
        offsetRelative : [e.pageX - <span class="hljs-property">@_dragState</span>.last[<span class="hljs-number">0</span>], e.pageY - <span class="hljs-property">@_dragState</span>.last[<span class="hljs-number">1</span>]]

      <span class="hljs-property">@_dragState</span>.inertia.update(dragEvent.offsetRelative)
      <span class="hljs-property">@_startInertia</span>()

  _onDrag : <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    dragEvent =
      offset         : [e.pageX - <span class="hljs-property">@_dragState</span>.origin[<span class="hljs-number">0</span>], e.pageY - <span class="hljs-property">@_dragState</span>.origin[<span class="hljs-number">1</span>]]
      offsetRelative : [e.pageX - <span class="hljs-property">@_dragState</span>.last[<span class="hljs-number">0</span>], e.pageY - <span class="hljs-property">@_dragState</span>.last[<span class="hljs-number">1</span>]]

    <span class="hljs-property">@dispatch</span>.drag(dragEvent)

    <span class="hljs-keyword">if</span> <span class="hljs-property">@inertia</span>
      <span class="hljs-property">@_dragState</span>.inertia.update(dragEvent.offsetRelative)

    <span class="hljs-property">@_dragState</span>.last = [e.pageX, e.pageY]

  _onInertia : <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@_inertiaRunning</span></pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>Apply damping and get x,y intertia values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    intertia = <span class="hljs-property">@_dragState</span>.inertia.damp().get()

    <span class="hljs-keyword">if</span> Math.abs(intertia[<span class="hljs-number">0</span>]) &lt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> Math.abs(intertia[<span class="hljs-number">1</span>]) &lt; <span class="hljs-number">1</span>
      <span class="hljs-property">@_stopInertia</span>()
      <span class="hljs-keyword">return</span>

    <span class="hljs-property">@dispatch</span>.drag(
      offset         : [<span class="hljs-property">@_dragState</span>.last[<span class="hljs-number">0</span>] - <span class="hljs-property">@_dragState</span>.origin[<span class="hljs-number">0</span>], <span class="hljs-property">@_dragState</span>.last[<span class="hljs-number">0</span>] - <span class="hljs-property">@_dragState</span>.origin[<span class="hljs-number">1</span>]]
      offsetRelative : intertia
    )
    <span class="hljs-property">@_dragState</span>.last = [<span class="hljs-property">@_dragState</span>.last[<span class="hljs-number">0</span>] + intertia[<span class="hljs-number">0</span>], <span class="hljs-property">@_dragState</span>.last[<span class="hljs-number">1</span>] + intertia[<span class="hljs-number">1</span>]]

    <span class="hljs-property">@_startInertia</span>()

  _startInertia :<span class="hljs-function"> =&gt;</span>
    <span class="hljs-property">@_inertiaRunning</span> = <span class="hljs-literal">true</span>
    setTimeout(<span class="hljs-property">@_onInertia</span>, seen.InertialMouse.inertiaMsecDelay)

  _stopInertia :<span class="hljs-function"> =&gt;</span>
    <span class="hljs-property">@_dragState</span>.inertia.reset()
    <span class="hljs-property">@_inertiaRunning</span> = <span class="hljs-literal">false</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Zoom</span></span>
  defaults :
    speed : <span class="hljs-number">0.25</span>

  constructor : <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@el</span>,  options)</span> -&gt;</span>
    seen.Util.defaults(@, options, <span class="hljs-property">@defaults</span>)
    <span class="hljs-property">@el</span>       = seen.Util.element(<span class="hljs-property">@el</span>)
    <span class="hljs-property">@_uid</span>     = seen.Util.uniqueId(<span class="hljs-string">'zoomer-'</span>)
    <span class="hljs-property">@dispatch</span> = seen.Events.dispatch(<span class="hljs-string">'zoom'</span>)
    <span class="hljs-property">@on</span>       = <span class="hljs-property">@dispatch</span>.<span class="hljs-literal">on</span>
    
    mouser    = <span class="hljs-keyword">new</span> seen.MouseEvents(<span class="hljs-property">@el</span>)
    mouser.<span class="hljs-literal">on</span> <span class="hljs-string">"mouseWheel.<span class="hljs-subst">#{<span class="hljs-property">@_uid</span>}</span>"</span>, <span class="hljs-property">@_onMouseWheel</span>

  _onMouseWheel : <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    sign       = e.wheelDelta / Math.abs(e.wheelDelta)
    zoomFactor = Math.abs(e.wheelDelta) / <span class="hljs-number">120</span> * <span class="hljs-property">@speed</span>
    zoom       = Math.pow(<span class="hljs-number">2</span>, sign*zoomFactor)

    <span class="hljs-property">@dispatch</span>.zoom({zoom})</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <h2 id="surfaces-and-shapes">Surfaces and Shapes</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>A <code>Surface</code> is a defined as a planar object in 3D space. These paths don’t necessarily need
to be convex, but they should be non-degenerate. This library does not support shapes with holes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Surface</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>When ‘false’ this will override backface culling, which is useful if your material is transparent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cullBackfaces : <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>Fill and stroke may be <code>Material</code> objects, which define the color and finish of the object and are rendered using the scene’s shader.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fill          : <span class="hljs-keyword">new</span> seen.Material(seen.C.gray)
  stroke        : <span class="hljs-literal">null</span>

  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@points</span>, <span class="hljs-property">@painter</span> = seen.Painters.path)</span> -&gt;</span>
    <span class="hljs-property">@id</span> = <span class="hljs-string">'s'</span> + seen.Util.uniqueId()</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>A <code>Shape</code> contains a collection of surface. They may create a closed 3D shape, but not necessarily.
For example, a cube is a closed shape, but a patch is not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Shape</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Transformable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@type</span>, <span class="hljs-property">@surfaces</span>)</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>Visit each surface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">eachSurface</span>: <span class="hljs-function"><span class="hljs-params">(f)</span> -&gt;</span>
    <span class="hljs-property">@surfaces</span>.forEach(f)
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>Apply the supplied fill <code>Material</code> to each surface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">fill</span>: <span class="hljs-function"><span class="hljs-params">(fill)</span> -&gt;</span>
    <span class="hljs-property">@eachSurface</span> <span class="hljs-function"><span class="hljs-params">(s)</span> -&gt;</span> s.fill = fill
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>Apply the supplied stroke <code>Material</code> to each surface</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">stroke</span>: <span class="hljs-function"><span class="hljs-params">(stroke)</span> -&gt;</span>
    <span class="hljs-property">@eachSurface</span> <span class="hljs-function"><span class="hljs-params">(s)</span> -&gt;</span> s.stroke = stroke
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>The object model class.
This class stores <code>Shapes</code>, <code>Lights</code>, and other <code>Models</code>
Since it extends <code>Transformable</code> it also contains a transformation matrix.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Model</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Transformable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@children</span> = []
    <span class="hljs-property">@lights</span>   = []</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>Add a <code>Shape</code>, <code>Light</code>, and other <code>Model</code> as a child of this <code>Model</code>
Any number of children can by supplied as arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">add</span>: <span class="hljs-function"><span class="hljs-params">(childs...)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> childs
      <span class="hljs-keyword">if</span> child <span class="hljs-keyword">instanceof</span> seen.Shape <span class="hljs-keyword">or</span> child <span class="hljs-keyword">instanceof</span> seen.Model
        <span class="hljs-property">@children</span>.push child
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> child <span class="hljs-keyword">instanceof</span> seen.Light
        <span class="hljs-property">@lights</span>.push child
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              <p>Create a new child model and return it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">append</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    model = <span class="hljs-keyword">new</span> seen.Model
    <span class="hljs-property">@add</span> model
    <span class="hljs-keyword">return</span> model</pre></div></div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>Visit each <code>Shape</code> in this <code>Model</code> and all recursive child <code>Model</code>s</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">eachShape</span>: <span class="hljs-function"><span class="hljs-params">(f)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@children</span>
      <span class="hljs-keyword">if</span> child <span class="hljs-keyword">instanceof</span> seen.Shape
        f.call(@, child)
      <span class="hljs-keyword">if</span> child <span class="hljs-keyword">instanceof</span> seen.Model
        child.eachShape(f)</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>Visit each <code>Light</code> and <code>Shape</code>, accumulating the recursive transformation matrices
along the way. The light callback will be called with each light and its accumulated
transform and it should return a <code>LightModel</code>. Each shape callback with be called
with each shape and its accumulated transform as well as the list of light models 
that apply to that shape.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  eachRenderable : <span class="hljs-function"><span class="hljs-params">(lightFn, shapeFn)</span> -&gt;</span>
    <span class="hljs-property">@_eachRenderable</span>(lightFn, shapeFn, [], <span class="hljs-property">@m</span>)

  _eachRenderable : <span class="hljs-function"><span class="hljs-params">(lightFn, shapeFn, lightModels, transform)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@lights</span>.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> lightModels = lightModels.slice()
    <span class="hljs-keyword">for</span> light <span class="hljs-keyword">in</span> <span class="hljs-property">@lights</span>
      <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> light.enabled
      lightModels.push lightFn.call(@, light, light.m.copy().multiply(transform))

    <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> <span class="hljs-property">@children</span>
      <span class="hljs-keyword">if</span> child <span class="hljs-keyword">instanceof</span> seen.Shape
        shapeFn.call(@, child, lightModels, child.m.copy().multiply(transform))
      <span class="hljs-keyword">if</span> child <span class="hljs-keyword">instanceof</span> seen.Model
        child._eachRenderable(lightFn, shapeFn, lightModels, child.m.copy().multiply(transform))


seen.Models = {</pre></div></div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              <p>The default model contains standard Hollywood-style 3-part lighting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-reserved">default</span> :<span class="hljs-function"> -&gt;</span>
    model = <span class="hljs-keyword">new</span> seen.Model()</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>Key light</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    model.add seen.Lights.directional
      normal    : seen.P(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>).normalize()
      color     : seen.Colors.hsl(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.7</span>)
      intensity : <span class="hljs-number">0.004</span></pre></div></div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              <p>Back light</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    model.add seen.Lights.directional
      normal    : seen.P(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>).normalize()
      intensity : <span class="hljs-number">0.003</span></pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>Fill light</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    model.add seen.Lights.ambient
      intensity : <span class="hljs-number">0.0015</span>

    <span class="hljs-keyword">return</span> model
}</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <h2 id="shapes">Shapes</h2>
<h4 id="shape-primitives-and-shape-making-methods">Shape primitives and shape-making methods</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
EQUILATERAL_TRIANGLE_ALTITUDE = Math.sqrt(<span class="hljs-number">3.0</span>) / <span class="hljs-number">2.0</span>

ICOS_X = <span class="hljs-number">0.525731112119133606</span>
ICOS_Z = <span class="hljs-number">0.850650808352039932</span>
ICOSAHEDRON_POINTS = [
  seen.P(-ICOS_X, <span class="hljs-number">0.0</span>,     -ICOS_Z)
  seen.P(ICOS_X,  <span class="hljs-number">0.0</span>,     -ICOS_Z)
  seen.P(-ICOS_X, <span class="hljs-number">0.0</span>,     ICOS_Z)
  seen.P(ICOS_X,  <span class="hljs-number">0.0</span>,     ICOS_Z)
  seen.P(<span class="hljs-number">0.0</span>,     ICOS_Z,  -ICOS_X)
  seen.P(<span class="hljs-number">0.0</span>,     ICOS_Z,  ICOS_X)
  seen.P(<span class="hljs-number">0.0</span>,     -ICOS_Z, -ICOS_X)
  seen.P(<span class="hljs-number">0.0</span>,     -ICOS_Z, ICOS_X)
  seen.P(ICOS_Z,  ICOS_X,  <span class="hljs-number">0.0</span>)
  seen.P(-ICOS_Z, ICOS_X,  <span class="hljs-number">0.0</span>)
  seen.P(ICOS_Z,  -ICOS_X, <span class="hljs-number">0.0</span>)
  seen.P(-ICOS_Z, -ICOS_X, <span class="hljs-number">0.0</span>)
]

ICOSAHEDRON_COORDINATE_MAP = [
  [<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>]
  [<span class="hljs-number">0</span>, <span class="hljs-number">9</span>, <span class="hljs-number">4</span>]
  [<span class="hljs-number">9</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>]
  [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>]
  [<span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>]
  [<span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">1</span>]
  [<span class="hljs-number">8</span>, <span class="hljs-number">3</span>, <span class="hljs-number">10</span>]
  [<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">8</span>]
  [<span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
  [<span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">3</span>]
  [<span class="hljs-number">7</span>, <span class="hljs-number">10</span>, <span class="hljs-number">3</span>]
  [<span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>]
  [<span class="hljs-number">7</span>, <span class="hljs-number">11</span>, <span class="hljs-number">6</span>]
  [<span class="hljs-number">11</span>, <span class="hljs-number">0</span>, <span class="hljs-number">6</span>]
  [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>]
  [<span class="hljs-number">6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>]
  [<span class="hljs-number">9</span>, <span class="hljs-number">0</span>, <span class="hljs-number">11</span>]
  [<span class="hljs-number">9</span>, <span class="hljs-number">11</span>, <span class="hljs-number">2</span>]
  [<span class="hljs-number">9</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>]
  [<span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">11</span>]
]

seen.Shapes = {
  _cubeCoordinateMap : [
    [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>] <span class="hljs-comment"># left</span>
    [<span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>] <span class="hljs-comment"># right</span>
    [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>] <span class="hljs-comment"># bottom</span>
    [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>] <span class="hljs-comment"># top</span>
    [<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>] <span class="hljs-comment"># front</span>
    [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">4</span>] <span class="hljs-comment"># back</span>
  ]

  <span class="hljs-attribute">_mapPointsToSurfaces</span>: <span class="hljs-function"><span class="hljs-params">(points, coordinateMap)</span> -&gt;</span>
    surfaces = []
    <span class="hljs-keyword">for</span> coords <span class="hljs-keyword">in</span> coordinateMap
      spts = (points[c].copy() <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> coords)
      surfaces.push(<span class="hljs-keyword">new</span> seen.Surface(spts))
    <span class="hljs-keyword">return</span> surfaces

  _subdivideTriangles : <span class="hljs-function"><span class="hljs-params">(triangles)</span> -&gt;</span>
    newTriangles = []
    <span class="hljs-keyword">for</span> tri <span class="hljs-keyword">in</span> triangles
      v01 = tri[<span class="hljs-number">0</span>].copy().add(tri[<span class="hljs-number">1</span>]).normalize()
      v12 = tri[<span class="hljs-number">1</span>].copy().add(tri[<span class="hljs-number">2</span>]).normalize()
      v20 = tri[<span class="hljs-number">2</span>].copy().add(tri[<span class="hljs-number">0</span>]).normalize()
      newTriangles.push [tri[<span class="hljs-number">0</span>], v01, v20]
      newTriangles.push [tri[<span class="hljs-number">1</span>], v12, v01]
      newTriangles.push [tri[<span class="hljs-number">2</span>], v20, v12]
      newTriangles.push [v01,    v12, v20]
    <span class="hljs-keyword">return</span> newTriangles</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>Returns a 2x2x2 cube, centered on the origin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">cube</span>:<span class="hljs-function"> =&gt;</span>
    points = [
      seen.P(-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)
      seen.P(-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>,  <span class="hljs-number">1</span>)
      seen.P(-<span class="hljs-number">1</span>,  <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)
      seen.P(-<span class="hljs-number">1</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">1</span>)
      seen.P( <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)
      seen.P( <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>,  <span class="hljs-number">1</span>)
      seen.P( <span class="hljs-number">1</span>,  <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)
      seen.P( <span class="hljs-number">1</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">1</span>)
    ]

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape(<span class="hljs-string">'cube'</span>, seen.Shapes._mapPointsToSurfaces(points, seen.Shapes._cubeCoordinateMap))</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>Returns a 1x1x1 cube from the origin to [1, 1, 1]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">unitcube</span>:<span class="hljs-function"> =&gt;</span>
    points = [
      seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
      seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
      seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
      seen.P(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      seen.P(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)
      seen.P(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
      seen.P(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
    ]

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape(<span class="hljs-string">'unitcube'</span>, seen.Shapes._mapPointsToSurfaces(points, seen.Shapes._cubeCoordinateMap))</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>Returns an axis-aligned 3D rectangle whose boundaries are defined by the two supplied points</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  rectangle : <span class="hljs-function"><span class="hljs-params">(point1, point2)</span> =&gt;</span>
    <span class="hljs-function"><span class="hljs-title">compose</span> = <span class="hljs-params">(x, y, z)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> seen.P(
        x(point1.x, point2.x)
        y(point1.y, point2.y)
        z(point1.z, point2.z)
      )

    points = [
      compose(Math.min, Math.min, Math.min)
      compose(Math.min, Math.min, Math.max)
      compose(Math.min, Math.max, Math.min)
      compose(Math.min, Math.max, Math.max)
      compose(Math.max, Math.min, Math.min)
      compose(Math.max, Math.min, Math.max)
      compose(Math.max, Math.max, Math.min)
      compose(Math.max, Math.max, Math.max)
    ]

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape(<span class="hljs-string">'rect'</span>, seen.Shapes._mapPointsToSurfaces(points, seen.Shapes._cubeCoordinateMap))</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>Returns a tetrahedron that fits inside a 2x2x2 cube.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">tetrahedron</span>:<span class="hljs-function"> =&gt;</span>
    points = [
      seen.P( <span class="hljs-number">1</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">1</span>)
      seen.P(-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>,  <span class="hljs-number">1</span>)
      seen.P(-<span class="hljs-number">1</span>,  <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)
      seen.P( <span class="hljs-number">1</span>, -<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)]

    coordinateMap = [
      [<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>]
      [<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>]
      [<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>]
      [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]]

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape(<span class="hljs-string">'tetrahedron'</span>, seen.Shapes._mapPointsToSurfaces(points, coordinateMap))</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>Returns a planar triangular patch. The supplied arguments determine the number of triangle in the patch.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">patch</span>: <span class="hljs-function"><span class="hljs-params">(nx = <span class="hljs-number">20</span>, ny = <span class="hljs-number">20</span>)</span> -&gt;</span>
    nx = Math.round(nx)
    ny = Math.round(ny)
    surfaces = []
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..nx]
      column = []
      <span class="hljs-keyword">for</span> y <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..ny]
        pts0 = [
          seen.P(x, y)
          seen.P(x + <span class="hljs-number">1</span>, y - <span class="hljs-number">0.5</span>)
          seen.P(x + <span class="hljs-number">1</span>, y + <span class="hljs-number">0.5</span>)
        ]
        pts1 = [
          seen.P(x, y)
          seen.P(x + <span class="hljs-number">1</span>, y + <span class="hljs-number">0.5</span>)
          seen.P(x, y + <span class="hljs-number">1</span>) 
        ]

        <span class="hljs-keyword">for</span> pts <span class="hljs-keyword">in</span> [pts0, pts1]
          <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> pts
            p.x *= EQUILATERAL_TRIANGLE_ALTITUDE
            p.y += <span class="hljs-keyword">if</span> x % <span class="hljs-number">2</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">0.5</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
          column.push pts

      <span class="hljs-keyword">if</span> x % <span class="hljs-number">2</span> <span class="hljs-keyword">isnt</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> column[<span class="hljs-number">0</span>]
          p.y += ny
        column.push column.shift()
      surfaces = surfaces.concat(column)

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'patch'</span>, surfaces.map((s) -&gt; <span class="hljs-keyword">new</span> seen.Surface(s)))</span>

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>Returns an icosahedron that fits within a 2x2x2 cube, centered on the origin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  icosahedron :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape(<span class="hljs-string">'icosahedron'</span>, seen.Shapes._mapPointsToSurfaces(ICOSAHEDRON_POINTS, ICOSAHEDRON_COORDINATE_MAP))</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>Returns a sub-divided icosahedron, which approximates a sphere with triangles of equal size.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sphere : <span class="hljs-function"><span class="hljs-params">(subdivisions = <span class="hljs-number">2</span>)</span> -&gt;</span>
    triangles = ICOSAHEDRON_COORDINATE_MAP.map <span class="hljs-function"><span class="hljs-params">(coords)</span> -&gt;</span> coords.map <span class="hljs-function"><span class="hljs-params">(c)</span> -&gt;</span> ICOSAHEDRON_POINTS[c]
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..subdivisions]
      triangles = seen.Shapes._subdivideTriangles(triangles)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'sphere'</span>, triangles.map (triangle) -&gt; <span class="hljs-keyword">new</span> seen.Surface(triangle.map (v) -&gt; v.copy()))</span>

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-165">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-165">&#182;</a>
              </div>
              <p>Return a text surface that can render 3D text when using an orthographic projection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">text</span>: <span class="hljs-function"><span class="hljs-params">(text)</span> -&gt;</span>
    surface = <span class="hljs-keyword">new</span> seen.Surface([
      seen.P(<span class="hljs-number">0</span>,  <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      seen.P(<span class="hljs-number">20</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>, <span class="hljs-number">0</span>)
    ], seen.Painters.text)
    surface.text = text
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape(<span class="hljs-string">'text'</span>, [surface])</pre></div></div>
            
        </li>
        
        
        <li id="section-166">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-166">&#182;</a>
              </div>
              <p>Returns a shape that is an extrusion of the supplied points into the z axis.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  extrude : <span class="hljs-function"><span class="hljs-params">(points, distance = <span class="hljs-number">1</span>)</span> -&gt;</span>
    surfaces = []
    front = <span class="hljs-keyword">new</span> seen.Surface (p.copy() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> points)
    back  = <span class="hljs-keyword">new</span> seen.Surface (p.translate(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,distance) <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> points)

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span>..points.length]
      surfaces.push <span class="hljs-keyword">new</span> seen.Surface [
        front.points[i - <span class="hljs-number">1</span>].copy()
        back.points[i - <span class="hljs-number">1</span>].copy()
        back.points[i].copy()
        front.points[i].copy()
      ]

    len = points.length
    surfaces.push <span class="hljs-keyword">new</span> seen.Surface [
      front.points[len - <span class="hljs-number">1</span>].copy()
      back.points[len - <span class="hljs-number">1</span>].copy()
      back.points[<span class="hljs-number">0</span>].copy()
      front.points[<span class="hljs-number">0</span>].copy()
    ]

    back.points.reverse()
    surfaces.push front
    surfaces.push back
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape(<span class="hljs-string">'extrusion'</span>, surfaces)</pre></div></div>
            
        </li>
        
        
        <li id="section-167">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-167">&#182;</a>
              </div>
              <p>Returns an extruded block arrow shape.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  arrow : <span class="hljs-function"><span class="hljs-params">(thickness = <span class="hljs-number">1</span>, tailLength = <span class="hljs-number">1</span>, tailWidth = <span class="hljs-number">1</span>, headLength = <span class="hljs-number">1</span>, headPointiness = <span class="hljs-number">0</span>)</span> -&gt;</span>
    htw = tailWidth/<span class="hljs-number">2</span>
    points = [
      seen.P(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
      seen.P(headLength + headPointiness, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
      seen.P(headLength, htw, <span class="hljs-number">0</span>)
      seen.P(headLength + tailLength, htw, <span class="hljs-number">0</span>)
      seen.P(headLength + tailLength, -htw, <span class="hljs-number">0</span>)
      seen.P(headLength, -htw, <span class="hljs-number">0</span>)
      seen.P(headLength + headPointiness, -<span class="hljs-number">1</span>, <span class="hljs-number">0</span>)
    ]
    <span class="hljs-keyword">return</span> seen.Shapes.extrude(points, thickness)</pre></div></div>
            
        </li>
        
        
        <li id="section-168">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-168">&#182;</a>
              </div>
              <p>Returns a shape with a single surface using the supplied points array </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  path : <span class="hljs-function"><span class="hljs-params">(points)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape(<span class="hljs-string">'path'</span>, [<span class="hljs-keyword">new</span> seen.Surface(points)])

  <span class="hljs-attribute">custom</span>: <span class="hljs-function"><span class="hljs-params">(s)</span> -&gt;</span>
    surfaces = []
    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> s.surfaces
      surfaces.push <span class="hljs-keyword">new</span> seen.Surface((seen.P(p...) <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> f))
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape(<span class="hljs-string">'custom'</span>, surfaces)
}</pre></div></div>
            
        </li>
        
        
        <li id="section-169">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-169">&#182;</a>
              </div>
              <p>Parser for Wavefront .obj files</p>
<p>Note: Wavefront .obj array indicies are 1-based.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">ObjParser</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@vertices</span> = []
    <span class="hljs-property">@faces</span>    = []
    <span class="hljs-property">@commands</span> =
      v : <span class="hljs-function"><span class="hljs-params">(data)</span> =&gt;</span> <span class="hljs-property">@vertices</span>.push data.map <span class="hljs-function"><span class="hljs-params">(d)</span> -&gt;</span> parseFloat(d)
      f : <span class="hljs-function"><span class="hljs-params">(data)</span> =&gt;</span> <span class="hljs-property">@faces</span>.push data.map <span class="hljs-function"><span class="hljs-params">(d)</span> -&gt;</span> parseInt(d)

  parse : <span class="hljs-function"><span class="hljs-params">(contents)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> contents.split(<span class="hljs-regexp">/[\r\n]+/</span>)
      data = line.trim().split(<span class="hljs-regexp">/[ ]+/</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-170">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-170">&#182;</a>
              </div>
              <p>Check data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> data.length &lt; <span class="hljs-number">2</span>
        <span class="hljs-keyword">continue</span>

      command = data.slice(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>]
      data    = data.slice(<span class="hljs-number">1</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-171">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-171">&#182;</a>
              </div>
              <p>Check command</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> command.charAt(<span class="hljs-number">0</span>) <span class="hljs-keyword">is</span> <span class="hljs-string">'#'</span>
        <span class="hljs-keyword">continue</span>
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@commands</span>[command]?
        <span class="hljs-built_in">console</span>.log <span class="hljs-string">"OBJ Parser: Skipping unknown command '<span class="hljs-subst">#{command}</span>'"</span>
        <span class="hljs-keyword">continue</span></pre></div></div>
            
        </li>
        
        
        <li id="section-172">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-172">&#182;</a>
              </div>
              <p>Execute command</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@commands</span>[command](data)

  mapFacePoints : <span class="hljs-function"><span class="hljs-params">(faceMap)</span> -&gt;</span>
    <span class="hljs-property">@faces</span>.map <span class="hljs-function"><span class="hljs-params">(face)</span> =&gt;</span>
      points = face.map <span class="hljs-function"><span class="hljs-params">(v)</span> =&gt;</span> seen.P(<span class="hljs-property">@vertices</span>[v - <span class="hljs-number">1</span>]...)
      <span class="hljs-keyword">return</span> faceMap.call(@, points)</pre></div></div>
            
        </li>
        
        
        <li id="section-173">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-173">&#182;</a>
              </div>
              <p>This method accepts Wavefront .obj file content and returns a <code>Shape</code> object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.Shapes.<span class="hljs-function"><span class="hljs-title">obj</span> = <span class="hljs-params">(objContents, cullBackfaces = <span class="hljs-literal">true</span>)</span> -&gt;</span>
  parser = <span class="hljs-keyword">new</span> seen.ObjParser()
  parser.parse(objContents)
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> seen.Shape<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'obj'</span>, parser.mapFacePoints((points) -&gt;
    surface = <span class="hljs-keyword">new</span> seen.Surface points
    surface.cullBackfaces = cullBackfaces
    <span class="hljs-keyword">return</span> surface
  ))</span>


</span></pre></div></div>
            
        </li>
        
        
        <li id="section-174">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-174">&#182;</a>
              </div>
              <h2 id="animator">Animator</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-175">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-175">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-176">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-176">&#182;</a>
              </div>
              <p>The animator class is useful for creating a render loop.
We supply pre and post render events for apply animation changes between renders.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Animator</span></span>
  constructor : <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@dispatch</span> = seen.Events.dispatch(<span class="hljs-string">'beforeRender'</span>, <span class="hljs-string">'afterRender'</span>, <span class="hljs-string">'render'</span>)
    <span class="hljs-property">@on</span>       = <span class="hljs-property">@dispatch</span>.<span class="hljs-literal">on</span>
    <span class="hljs-property">@_running</span> = <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-177">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-177">&#182;</a>
              </div>
              <p>Start the render loop. The delay between frames can be supplied as an argument.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">start</span>: <span class="hljs-function"><span class="hljs-params">(msecDelay = <span class="hljs-number">30</span>)</span> -&gt;</span>
    <span class="hljs-property">@_running</span>   = <span class="hljs-literal">true</span>
    <span class="hljs-property">@_msecDelay</span> = msecDelay
    setTimeout(<span class="hljs-property">@render</span>, <span class="hljs-property">@_msecDelay</span>)
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-178">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-178">&#182;</a>
              </div>
              <p>Stop the render loop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stop :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@_running</span> = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-179">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-179">&#182;</a>
              </div>
              <p>The main render loop method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-attribute">render</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> <span class="hljs-property">@_running</span>
    <span class="hljs-property">@dispatch</span>.beforeRender()
    <span class="hljs-property">@dispatch</span>.render()
    <span class="hljs-property">@dispatch</span>.afterRender()
    setTimeout(<span class="hljs-property">@render</span>, <span class="hljs-property">@_msecDelay</span>)
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-180">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-180">&#182;</a>
              </div>
              <p>Add a callback that will be invoked before the render</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onBefore : <span class="hljs-function"><span class="hljs-params">(handler)</span> -&gt;</span>
    <span class="hljs-property">@on</span> <span class="hljs-string">"beforeRender.<span class="hljs-subst">#{seen.Util.uniqueId(<span class="hljs-string">'animator-'</span>)}</span>"</span>, handler
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-181">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-181">&#182;</a>
              </div>
              <p>Add a callback that will be invoked after the render</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onAfter : <span class="hljs-function"><span class="hljs-params">(handler)</span> -&gt;</span>
    <span class="hljs-property">@on</span> <span class="hljs-string">"afterRender.<span class="hljs-subst">#{seen.Util.uniqueId(<span class="hljs-string">'animator-'</span>)}</span>"</span>, handler
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-182">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-182">&#182;</a>
              </div>
              <p>Add a render callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  onRender : <span class="hljs-function"><span class="hljs-params">(handler)</span> -&gt;</span>
    <span class="hljs-property">@on</span> <span class="hljs-string">"render.<span class="hljs-subst">#{seen.Util.uniqueId(<span class="hljs-string">'animator-'</span>)}</span>"</span>, handler
    <span class="hljs-keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-183">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-183">&#182;</a>
              </div>
              <h2 id="camera">Camera</h2>
<h4 id="projections-viewports-and-cameras">Projections, Viewports, and Cameras</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-184">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-184">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-185">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-185">&#182;</a>
              </div>
              <p>These projection methods return a 3D to 2D <code>Matrix</code> transformation.
Each projection assumes the camera is located at (0,0,0).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>seen.Projections = {</pre></div></div>
            
        </li>
        
        
        <li id="section-186">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-186">&#182;</a>
              </div>
              <p>Creates a perspective projection matrix </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  perspectiveFov : <span class="hljs-function"><span class="hljs-params">(fovyInDegrees = <span class="hljs-number">50</span>, front = <span class="hljs-number">1</span>)</span> -&gt;</span>
    tan = front * Math.tan(fovyInDegrees * Math.PI / <span class="hljs-number">360.0</span>)
    <span class="hljs-keyword">return</span> seen.Projections.perspective(-tan, tan, -tan, tan, front, <span class="hljs-number">2</span>*front)</pre></div></div>
            
        </li>
        
        
        <li id="section-187">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-187">&#182;</a>
              </div>
              <p>Creates a perspective projection matrix with the supplied frustrum</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  perspective : <span class="hljs-function"><span class="hljs-params">(left=-<span class="hljs-number">1</span>, right=<span class="hljs-number">1</span>, bottom=-<span class="hljs-number">1</span>, top=<span class="hljs-number">1</span>, near=<span class="hljs-number">1</span>, far=<span class="hljs-number">100</span>)</span> -&gt;</span>
    near2 = <span class="hljs-number">2</span> * near
    dx    = right - left
    dy    = top - bottom
    dz    = far - near

    m = <span class="hljs-keyword">new</span> Array(<span class="hljs-number">16</span>)
    m[<span class="hljs-number">0</span>]  = near2 / dx
    m[<span class="hljs-number">1</span>]  = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">2</span>]  = (right + left) / dx
    m[<span class="hljs-number">3</span>]  = <span class="hljs-number">0.0</span>

    m[<span class="hljs-number">4</span>]  = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">5</span>]  = near2 / dy
    m[<span class="hljs-number">6</span>]  = (top + bottom) / dy
    m[<span class="hljs-number">7</span>]  = <span class="hljs-number">0.0</span>

    m[<span class="hljs-number">8</span>]  = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">9</span>]  = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">10</span>] = -(far + near) / dz
    m[<span class="hljs-number">11</span>] = -(far * near2) / dz

    m[<span class="hljs-number">12</span>] = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">13</span>] = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">14</span>] = -<span class="hljs-number">1.0</span>
    m[<span class="hljs-number">15</span>] = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">return</span> seen.M(m)

  ortho : <span class="hljs-function"><span class="hljs-params">(left=-<span class="hljs-number">1</span>, right=<span class="hljs-number">1</span>, bottom=-<span class="hljs-number">1</span>, top=<span class="hljs-number">1</span>, near=<span class="hljs-number">1</span>, far=<span class="hljs-number">100</span>)</span> -&gt;</span>
    near2 = <span class="hljs-number">2</span> * near
    dx    = right - left
    dy    = top - bottom
    dz    = far - near

    m = <span class="hljs-keyword">new</span> Array(<span class="hljs-number">16</span>)
    m[<span class="hljs-number">0</span>]  = <span class="hljs-number">2</span> / dx
    m[<span class="hljs-number">1</span>]  = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">2</span>]  = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">3</span>]  = (right + left) / dx

    m[<span class="hljs-number">4</span>]  = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">5</span>]  = <span class="hljs-number">2</span> / dy
    m[<span class="hljs-number">6</span>]  = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">7</span>]  = -(top + bottom) / dy

    m[<span class="hljs-number">8</span>]  = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">9</span>]  = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">10</span>] = -<span class="hljs-number">2</span> / dz
    m[<span class="hljs-number">11</span>] = -(far + near) / dz

    m[<span class="hljs-number">12</span>] = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">13</span>] = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">14</span>] = <span class="hljs-number">0.0</span>
    m[<span class="hljs-number">15</span>] = <span class="hljs-number">1.0</span>
    <span class="hljs-keyword">return</span> seen.M(m)
}

seen.Viewports = {
  center : <span class="hljs-function"><span class="hljs-params">(width = <span class="hljs-number">500</span>, height = <span class="hljs-number">500</span>, x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>)</span> -&gt;</span>
    prescale = seen.M()
      .translate(-x, -y, -<span class="hljs-number">1</span>)
      .scale(<span class="hljs-number">1</span>/width, <span class="hljs-number">1</span>/height, <span class="hljs-number">1</span>/height)
    postscale = seen.M()
      .scale(width, -height, height)
      .translate(x + width/<span class="hljs-number">2</span>, y + height/<span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> {prescale, postscale}

  origin : <span class="hljs-function"><span class="hljs-params">(width = <span class="hljs-number">500</span>, height = <span class="hljs-number">500</span>, x = <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>)</span> -&gt;</span>
    prescale = seen.M()
      .translate(-x, -y, -<span class="hljs-number">1</span>)
      .scale(<span class="hljs-number">1</span>/width, <span class="hljs-number">1</span>/height, <span class="hljs-number">1</span>/height)
    postscale = seen.M()
      .scale(width, -height, height)
      .translate(x, y)
    <span class="hljs-keyword">return</span> {prescale, postscale}
}</pre></div></div>
            
        </li>
        
        
        <li id="section-188">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-188">&#182;</a>
              </div>
              <p>The <code>Camera</code> model contains all three major components of the 3D to 2D tranformation.</p>
<p>First, we transform object from world-space (the same space that the coordinates of
surface points are in after all their transforms are applied) to camera space. Typically,
this will place all viewable objects into a cube with coordinates:
x = -1 to 1, y = -1 to 1, z = 1 to 2</p>
<p>Second, we apply the projection trasform to create perspective parallax and what not.</p>
<p>Finally, we rescale to the viewport size.</p>
<p>These three steps allow us to easily create shapes whose coordinates match up to
screen coordinates in the z = 0 plane.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Camera</span></span>
  defaults :
    projection : seen.Projections.perspective()
    viewport   : seen.Viewports.center()
    camera     : seen.Matrices.identity()

  constructor : <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    seen.Util.defaults(@, options, <span class="hljs-property">@defaults</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-189">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-189">&#182;</a>
              </div>
              <p>Performs the 3-step multiplication of the transformation matrices.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getMatrix :<span class="hljs-function"> -&gt;</span>
    <span class="hljs-property">@camera</span>.copy().multiply(<span class="hljs-property">@viewport</span>.prescale).multiply(<span class="hljs-property">@projection</span>).multiply(<span class="hljs-property">@viewport</span>.postscale)</pre></div></div>
            
        </li>
        
        
        <li id="section-190">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-190">&#182;</a>
              </div>
              <h2 id="the-scene">The Scene</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-191">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-191">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-192">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-192">&#182;</a>
              </div>
              <p>A <code>Scene</code> is the main object for a view of a scene.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">seen</span>.<span class="hljs-title">Scene</span></span>
  <span class="hljs-attribute">defaults</span>:</pre></div></div>
            
        </li>
        
        
        <li id="section-193">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-193">&#182;</a>
              </div>
              <p>The root model for the scene, which contains <code>Shape</code>s and <code>Light</code>s</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    model            : <span class="hljs-keyword">new</span> seen.Model()</pre></div></div>
            
        </li>
        
        
        <li id="section-194">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-194">&#182;</a>
              </div>
              <p><code>Camera</code> which defines the projection from shape-space to screen-space.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    camera           : <span class="hljs-keyword">new</span> seen.Camera()</pre></div></div>
            
        </li>
        
        
        <li id="section-195">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-195">&#182;</a>
              </div>
              <p>The scene’s shader determines which lighting model is used.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    shader           : seen.Shaders.phong</pre></div></div>
            
        </li>
        
        
        <li id="section-196">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-196">&#182;</a>
              </div>
              <p>This boolean can be used to turn off backface-culling for the whole
scene. Beware, turning this off can slow down a scene’s rendering
by a factor of 2. You can also turn off backface-culling for
individual surfaces with a boolean on those objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cullBackfaces    : <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-197">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-197">&#182;</a>
              </div>
              <p>This boolean determines if we round the surface coordinates to the
nearest integer. Rounding the coordinates before display speeds up
path drawing at the cost of a slight jittering effect when animating.
Anecdotally, my speedup on a complex demo scene was 10 FPS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fractionalPoints : <span class="hljs-literal">false</span>

  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(options)</span> -&gt;</span>
    seen.Util.defaults(@, options, <span class="hljs-property">@defaults</span>)
    <span class="hljs-property">@_renderModelCache</span> = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-198">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-198">&#182;</a>
              </div>
              <p>The primary method that produces the render models, which are then used
by the <code>RenderContext</code> to paint the scene.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  render : <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-199">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-199">&#182;</a>
              </div>
              <p>Compute the projection matrix.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    projection = <span class="hljs-property">@camera</span>.getMatrix()

    renderModels = []
    <span class="hljs-property">@model</span>.eachRenderable(
      <span class="hljs-function"><span class="hljs-params">(light, transform)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-200">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-200">&#182;</a>
              </div>
              <p>Compute light model data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">new</span> seen.LightRenderModel(light, transform)

      <span class="hljs-function"><span class="hljs-params">(shape, lights, transform)</span> =&gt;</span>
        <span class="hljs-keyword">for</span> surface <span class="hljs-keyword">in</span> shape.surfaces</pre></div></div>
            
        </li>
        
        
        <li id="section-201">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-201">&#182;</a>
              </div>
              <p>Compute transformed and projected geometry.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          renderModel = <span class="hljs-property">@_renderSurface</span>(surface, transform, projection)</pre></div></div>
            
        </li>
        
        
        <li id="section-202">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-202">&#182;</a>
              </div>
              <p>Test projected normal’s z-coordinate for culling (if enabled).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> <span class="hljs-property">@cullBackfaces</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> surface.cullBackfaces <span class="hljs-keyword">or</span> renderModel.projected.normal.z &lt; <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-203">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-203">&#182;</a>
              </div>
              <p>Render fill and stroke using material and shader.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            renderModel.fill   = surface.fill?.render(lights, <span class="hljs-property">@shader</span>, renderModel.transformed)
            renderModel.stroke = surface.stroke?.render(lights, <span class="hljs-property">@shader</span>, renderModel.transformed)</pre></div></div>
            
        </li>
        
        
        <li id="section-204">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-204">&#182;</a>
              </div>
              <p>Round coordinates</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> <span class="hljs-property">@fractionalPoints</span> <span class="hljs-keyword">isnt</span> <span class="hljs-literal">true</span>
              p.round() <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> renderModel.projected.points

            renderModels.push renderModel
    )</pre></div></div>
            
        </li>
        
        
        <li id="section-205">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-205">&#182;</a>
              </div>
              <p>Sort render models by projected z coordinate. This ensures that the surfaces
farthest from the eye are painted first. (Painter’s Algorithm)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    renderModels.sort <span class="hljs-function"><span class="hljs-params">(a, b)</span> -&gt;</span>
      <span class="hljs-keyword">return</span>  b.projected.barycenter.z - a.projected.barycenter.z

    <span class="hljs-keyword">return</span> renderModels</pre></div></div>
            
        </li>
        
        
        <li id="section-206">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-206">&#182;</a>
              </div>
              <p>Get or create the rendermodel for the given surface. We cache these models to reduce object creation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _renderSurface : <span class="hljs-function"><span class="hljs-params">(surface, transform, projection)</span> -&gt;</span>
    renderModel = <span class="hljs-property">@_renderModelCache</span>[surface.id]
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> renderModel?
      renderModel = <span class="hljs-property">@_renderModelCache</span>[surface.id] = <span class="hljs-keyword">new</span> seen.RenderModel(surface, transform, projection)
    <span class="hljs-keyword">else</span>
      renderModel.update(transform, projection)
    <span class="hljs-keyword">return</span> renderModel

  flush : <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>
    <span class="hljs-property">@_renderModelCache</span> = {}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
