(function(){var t,n,e,r,i,o,s,u,a,h,l,p,f,y,d,m,_,v,g,x,w=function(t,n){return function(){return t.apply(n,arguments)}},b={}.hasOwnProperty,M=function(t,n){function e(){this.constructor=t}for(var r in n)b.call(n,r)&&(t[r]=n[r]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t};l=("undefined"!=typeof exports&&null!==exports?exports:this).seen={},o=1,l.Util={defaults:function(t,n,e){var r,i;for(r in n)null==t[r]&&(t[r]=n[r]);i=[];for(r in e)null==t[r]?i.push(t[r]=e[r]):i.push(void 0);return i},arraysEqual:function(t,n){var e,r,i,o;if(!t.length===n.length)return!1;for(e=i=0,o=t.length;o>i;e=++i)if(r=t[e],r!==n[e])return!1;return!0},uniqueId:function(){return o++}},l.Events={dispatch:function(){var t,n,e,r;for(n=new l.Events.Dispatcher,e=0,r=arguments.length;r>e;e++)t=arguments[e],n[t]=l.Events.Event();return n}},l.Events.Dispatcher=function(){function t(){this.on=w(this.on,this)}return t.prototype.on=function(t,n){var e,r;return e=t.indexOf("."),r="",e>0&&(r=t.substring(e+1),t=t.substring(0,e)),null!=this[t]&&this[t].on(r,n),this},t}(),l.Events.Event=function(){var t,n,e;return e=[],n={},t=function(){var t,n,r,i;for(i=[],n=0,r=e.length;r>n;n++)t=e[n],i.push(t.apply(this,arguments));return i},t.on=function(t,r){var i,o;return i=n[t],i&&(e=e.slice(0,o=e.indexOf(i)).concat(e.slice(o+1)),delete n[t]),r?(e.push(r),n[t]=r):void 0},t},t=new Array(16),i=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],l.Matrix=function(){function n(t){return this.m=null!=t?t:null,null==this.m&&(this.m=i.slice()),this}return n.prototype.copy=function(){return new l.Matrix(this.m.slice())},n.prototype.reset=function(){return this.m=i.slice(),this},n.prototype.multiply=function(t){return this.copy()._multiply(t)},n.prototype.multiplyM=function(t){return this.copy()._multiplyM(t)},n.prototype.rotx=function(t){return this.copy()._rotx(t)},n.prototype.roty=function(t){return this.copy()._roty(t)},n.prototype.rotz=function(t){return this.copy()._rotz(t)},n.prototype.translate=function(t,n,e){return this.copy()._translate(t,n,e)},n.prototype.scale=function(t,n){return this.copy()._scale(t,n,t)},n.prototype._multiply=function(t){return this._multiplyM(t.m)},n.prototype._multiplyM=function(n){var e,r,i,o,s;for(e=t,i=o=0;4>o;i=++o)for(r=s=0;16>s;r=s+=4)e[r+i]=n[r]*this.m[i]+n[r+1]*this.m[4+i]+n[r+2]*this.m[8+i]+n[r+3]*this.m[12+i];return t=this.m,this.m=e,this},n.prototype._rotx=function(t){var n,e,r;return n=Math.cos(t),r=Math.sin(t),e=[1,0,0,0,0,n,-r,0,0,r,n,0,0,0,0,1],this._multiplyM(e)},n.prototype._roty=function(t){var n,e,r;return n=Math.cos(t),r=Math.sin(t),e=[n,0,r,0,0,1,0,0,-r,0,n,0,0,0,0,1],this._multiplyM(e)},n.prototype._rotz=function(t){var n,e,r;return n=Math.cos(t),r=Math.sin(t),e=[n,-r,0,0,r,n,0,0,0,0,1,0,0,0,0,1],this._multiplyM(e)},n.prototype._translate=function(t,n,e){return null==t&&(t=0),null==n&&(n=0),null==e&&(e=0),this.m[3]+=t,this.m[7]+=n,this.m[11]+=e,this},n.prototype._scale=function(t,n,e){return null==t&&(t=1),null==n&&(n=t),null==e&&(e=n),this.m[0]*=t,this.m[5]*=n,this.m[10]*=e,this},n}(),l.M=function(t){return new l.Matrix(t)},l.Matrices={identity:l.M(),flipX:l.M().scale(-1,1,1),flipY:l.M().scale(1,-1,1),flipZ:l.M().scale(1,1,-1)},l.Transformable=function(){function t(){this.m=new l.Matrix}return t.prototype.scale=function(t,n,e){return this.m._scale(t,n,e),this},t.prototype.translate=function(t,n,e){return this.m._translate(t,n,e),this},t.prototype.rotx=function(t){return this.m._rotx(t),this},t.prototype.roty=function(t){return this.m._roty(t),this},t.prototype.rotz=function(t){return this.m._rotz(t),this},t.prototype.matrix=function(t){return this.m._multiplyM(t),this},t.prototype.transform=function(t){return this.m._multiply(t),this},t.prototype.reset=function(){return this.m.reset(),this},t}(),l.Point=function(){function t(t,n,e,r){this.x=null!=t?t:0,this.y=null!=n?n:0,this.z=null!=e?e:0,this.w=null!=r?r:1}return t.prototype.transform=function(t){var n;return n=s,n.x=this.x*t.m[0]+this.y*t.m[1]+this.z*t.m[2]+this.w*t.m[3],n.y=this.x*t.m[4]+this.y*t.m[5]+this.z*t.m[6]+this.w*t.m[7],n.z=this.x*t.m[8]+this.y*t.m[9]+this.z*t.m[10]+this.w*t.m[11],n.w=this.x*t.m[12]+this.y*t.m[13]+this.z*t.m[14]+this.w*t.m[15],this.set(n),this},t.prototype.set=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t.prototype.copy=function(){return new l.Point(this.x,this.y,this.z,this.w)},t.prototype.normalize=function(){return this.copy()._normalize()},t.prototype.translate=function(t,n,e){var r;return r=this.copy(),r.x+=t,r.y+=n,r.z+=e,r},t.prototype.add=function(t){return this.copy()._add(t)},t.prototype.subtract=function(t){return this.copy()._subtract(t)},t.prototype.cross=function(t){return this.copy()._cross(t)},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.prototype.multiply=function(t){return this.copy()._multiply(t)},t.prototype.divide=function(t){return this.copy()._divide(t)},t.prototype._multiply=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.prototype._divide=function(t){return this.x/=t,this.y/=t,this.z/=t,this},t.prototype._normalize=function(){var t;return t=Math.sqrt(this.dot(this)),0===t?this.set(l.Points.Z):this._divide(t),this},t.prototype._add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},t.prototype._subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},t.prototype._cross=function(t){var n;return n=s,n.x=this.y*t.z-this.z*t.y,n.y=this.z*t.x-this.x*t.z,n.z=this.x*t.y-this.y*t.x,this.set(n),this},t.prototype.toJSON=function(){return[this.x,this.y,this.z,this.w]},t}(),l.P=function(t,n,e,r){return new l.Point(t,n,e,r)},s=l.P(),l.Points={X:l.P(1,0,0),Y:l.P(0,1,0),Z:l.P(0,0,1),ZERO:l.P(0,0,0)},l.Color=function(){function t(t,n,e,r){this.r=null!=t?t:0,this.g=null!=n?n:0,this.b=null!=e?e:0,this.a=null!=r?r:255}return t.prototype.copy=function(){return new l.Color(this.r,this.g,this.b,this.a)},t.prototype.scale=function(t){return this.copy()._scale(t)},t.prototype.offset=function(){return this.copy()._offset(c)},t.prototype.clamp=function(t,n){return this.copy()._clamp(t,n)},t.prototype.addChannels=function(t){return this.copy()._addChannels(t)},t.prototype.multiplyChannels=function(t){return this.copy()._multiplyChannels(t)},t.prototype._scale=function(t){return this.r*=t,this.g*=t,this.b*=t,this},t.prototype._offset=function(t){return this.r+=t,this.g+=t,this.b+=t,this},t.prototype._clamp=function(t,n){return null==t&&(t=0),null==n&&(n=255),this.r=Math.min(n,Math.max(t,this.r)),this.g=Math.min(n,Math.max(t,this.g)),this.b=Math.min(n,Math.max(t,this.b)),this},t.prototype._addChannels=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this},t.prototype._multiplyChannels=function(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this},t.prototype.hex=function(){var t;for(t=(this.r<<16|this.g<<8|this.b).toString(16);t.length<6;)t="0"+t;return"#"+t},t.prototype.style=function(){return"rgba("+this.r+","+this.g+","+this.b+","+this.a+")"},t}(),l.Colors={rgb:function(t,n,e,r){return null==r&&(r=255),new l.Color(t,n,e,r)},hex:function(t){return"#"===t.charAt(0)&&(t=t.substring(1)),new l.Color(parseInt(t.substring(0,2),16),parseInt(t.substring(2,4),16),parseInt(t.substring(4,6),16))},hsl:function(t,n,e,r){var i,o,s,u,a,h;return null==r&&(r=1),h=o=i=0,0===n?h=o=i=e:(s=function(t,n,e){return 0>e?e+=1:e>1&&(e-=1),1/6>e?t+6*(n-t)*e:.5>e?n:2/3>e?t+6*(n-t)*(2/3-e):t},a=.5>e?e*(1+n):e+n-e*n,u=2*e-a,h=s(u,a,t+1/3),o=s(u,a,t),i=s(u,a,t-1/3)),new l.Color(255*h,255*o,255*i,255*r)}},l.C=l.Colors,l.C.black=l.C.hex("#000000"),l.C.white=l.C.hex("#FFFFFF"),l.C.gray=l.C.hex("#888888"),l.Material=function(){function t(t,n){this.color=t,null==n&&(n={}),l.Util.defaults(this,n,this.defaults)}return t.prototype.defaults={color:l.C.gray,metallic:!1,specularColor:l.C.white,specularExponent:8,shader:null},t.prototype.render=function(t,n,e){var r,i,o;return i=null!=(o=this.shader)?o:n,r=i.shade(t,e,this),r.a=this.color.a,r},t}(),l.Light=function(t){function n(t,e){this.type=t,n.__super__.constructor.apply(this,arguments),l.Util.defaults(this,e,this.defaults),this.id="l"+l.Util.uniqueId()}return M(n,t),n.prototype.defaults={point:l.P(),color:l.C.white,intensity:.01,normal:l.P(1,-1,-1).normalize()},n.prototype.render=function(){return this.colorIntensity=this.color.scale(this.intensity)},n}(l.Transformable),l.Lights={point:function(t){return new l.Light("point",t)},directional:function(t){return new l.Light("directional",t)},ambient:function(t){return new l.Light("ambient",t)}},l.ShaderUtils={applyDiffuse:function(t,n,e,r){var i;return i=e.dot(r),i>0?t._addChannels(n.colorIntensity.scale(i)):void 0},applyDiffuseAndSpecular:function(t,n,e,r,i){var o,s,u,a;return o=e.dot(r),o>0?(t._addChannels(n.colorIntensity.scale(o)),s=l.Points.Z,u=r.multiply(2*o).subtract(e),a=Math.pow(1+u.dot(s),i.specularExponent),t._offset(a*n.intensity)):void 0},applyAmbient:function(t,n){return t._addChannels(n.colorIntensity)}},l.Shader=function(){function t(){}return t.prototype.shade=function(){},t}(),a=function(t){function n(){return f=n.__super__.constructor.apply(this,arguments)}return M(n,t),n.prototype.shade=function(t,n,e){var r,i,o,s,u;for(r=new l.Color,s=0,u=t.length;u>s;s++)switch(i=t[s],i.type){case"point":o=i.point.subtract(n.barycenter).normalize(),l.ShaderUtils.applyDiffuseAndSpecular(r,i,o,n.normal,e);break;case"directional":l.ShaderUtils.applyDiffuseAndSpecular(r,i,i.normal,n.normal,e);break;case"ambient":l.ShaderUtils.applyAmbient(r,i)}return r._multiplyChannels(e.color)._clamp(0,255),r},n}(l.Shader),e=function(t){function n(){return y=n.__super__.constructor.apply(this,arguments)}return M(n,t),n.prototype.shade=function(t,n,e){var r,i,o,s,u;for(r=new l.Color,s=0,u=t.length;u>s;s++)switch(i=t[s],i.type){case"point":o=i.point.subtract(n.barycenter).normalize(),l.ShaderUtils.applyDiffuse(r,i,o,n.normal,e);break;case"directional":l.ShaderUtils.applyDiffuse(r,i,i.normal,n.normal,e);break;case"ambient":l.ShaderUtils.applyAmbient(r,i)}return r._multiplyChannels(e.color)._clamp(0,255),r},n}(l.Shader),n=function(t){function n(){return d=n.__super__.constructor.apply(this,arguments)}return M(n,t),n.prototype.shade=function(t,n,e){var r,i,o,s;for(r=new l.Color,o=0,s=t.length;s>o;o++)switch(i=t[o],i.type){case"ambient":l.ShaderUtils.applyAmbient(r,i)}return r._multiplyChannels(e.color)._clamp(0,255),r},n}(l.Shader),r=function(t){function n(){return m=n.__super__.constructor.apply(this,arguments)}return M(n,t),n.prototype.shade=function(t,n,e){return e.color},n}(l.Shader),l.Shaders={phong:new a,diffuse:new e,ambient:new n,flat:new r},l.Renderer=function(){function t(t){this.scene=t,this.render=w(this.render,this),this.scene.on("render.renderer-"+l.Util.uniqueId(),this.render)}return t.prototype.render=function(t){var n,e,r;for(this.reset(),e=0,r=t.length;r>e;e++)n=t[e],n.surface.painter.paint(n,this);return this.hideUnused()},t.prototype.path=function(){},t.prototype.text=function(){},t}(),l.RenderModel=function(){function t(t,n,e){this.surface=t,this.transform=n,this.projection=e,this.points=this.surface.points,this.transformed=this._initRenderData(),this.projected=this._initRenderData(),this._update()}return t.prototype.update=function(t,n){return l.Util.arraysEqual(t.m,this.transform.m)&&l.Util.arraysEqual(n.m,this.projection.m)?void 0:(this.transform=t,this.projection=n,this._update())},t.prototype._update=function(){return this._math(this.transformed,this.points,this.transform,!1),this._math(this.projected,this.transformed.points,this.projection,!0)},t.prototype._initRenderData=function(){var t;return{points:function(){var n,e,r,i;for(r=this.points,i=[],n=0,e=r.length;e>n;n++)t=r[n],i.push(t.copy());return i}.call(this),barycenter:l.P(),normal:l.P(),v0:l.P(),v1:l.P()}},t.prototype._math=function(t,n,e,r){var i,o,s,u,a,h,p,c;for(null==r&&(r=!1),i=u=0,h=n.length;h>u;i=++u)o=n[i],s=t.points[i],s.set(o).transform(e),r&&s._divide(s.w);for(t.barycenter.set(l.Points.ZERO),c=t.points,a=0,p=c.length;p>a;a++)o=c[a],t.barycenter._add(o);return t.barycenter._divide(t.points.length),t.v0.set(t.points[1])._subtract(t.points[0]),t.v1.set(t.points[n.length-1])._subtract(t.points[0]),t.normal.set(t.v0._cross(t.v1)._normalize())},t}(),l.LightRenderModel=function(){function t(t,n){var e;this.colorIntensity=t.color.scale(t.intensity),this.type=t.type,this.intensity=t.intensity,this.point=t.point.copy().transform(n),e=l.Points.ZERO.copy().transform(n),this.normal=t.normal.copy().transform(n)._subtract(e)._normalize()}return t}(),l.Surface=function(){function t(t,n){this.points=t,this.painter=null!=n?n:l.Painters.path,this.id="s"+l.Util.uniqueId()}return t.prototype.cullBackfaces=!0,t.prototype.fill=new l.Material(l.C.gray),t.prototype.stroke=null,t}(),l.Shape=function(t){function n(t,e){this.type=t,this.surfaces=e,n.__super__.constructor.call(this)}return M(n,t),n.prototype.eachSurface=function(t){return this.surfaces.forEach(t),this},n.prototype.fill=function(t){return this.eachSurface(function(n){return n.fill=t}),this},n.prototype.stroke=function(t){return this.eachSurface(function(n){return n.stroke=t}),this},n}(l.Transformable),l.Model=function(t){function n(){n.__super__.constructor.call(this),this.children=[],this.lights=[]}return M(n,t),n.prototype.add=function(t){return this.children.push(t),this},n.prototype.append=function(){var t;return t=new l.Model,this.add(t),t},n.prototype.eachShape=function(t){var n,e,r,i,o;for(i=this.children,o=[],e=0,r=i.length;r>e;e++)n=i[e],n instanceof l.Shape&&t.call(this,n),n instanceof l.Model?o.push(n.eachShape(t)):o.push(void 0);return o},n.prototype.eachRenderable=function(t,n){return this._eachRenderable(t,n,[],this.m)},n.prototype._eachRenderable=function(t,n,e,r){var i,o,s,u,a,h,p,c,f;for(this.lights.length>0&&(e=e.slice()),p=this.lights,s=0,a=p.length;a>s;s++)o=p[s],e.push(t.call(this,o,o.m.multiply(r)));for(c=this.children,f=[],u=0,h=c.length;h>u;u++)i=c[u],i instanceof l.Shape&&n.call(this,i,e,i.m.multiply(r)),i instanceof l.Model?f.push(i._eachRenderable(t,n,e,i.m.multiply(r))):f.push(void 0);return f},n}(l.Transformable),l.Painter=function(){function t(){}return t.prototype.paint=function(){},t}(),u=function(t){function n(){return _=n.__super__.constructor.apply(this,arguments)}return M(n,t),n.prototype.paint=function(t,n){var e,r;return n.path().path(t.projected.points).style({fill:null==t.fill?"none":t.fill.hex(),stroke:null==t.stroke?"none":t.stroke.hex(),"fill-opacity":null==(null!=(e=t.fill)?e.a:void 0)?1:t.fill.a/255,"stroke-width":null!=(r=t.surface["stroke-width"])?r:1})},n}(l.Painter),h=function(t){function n(){return v=n.__super__.constructor.apply(this,arguments)}return M(n,t),n.prototype.paint=function(t,n){var e;return n.text().text(t.surface.text).transform(t.transform.multiply(t.projection)).style({fill:null==t.fill?"none":t.fill.hex(),stroke:null==t.stroke?"none":t.stroke.hex(),"text-anchor":null!=(e=t.surface.anchor)?e:"middle"})},n}(l.Painter),l.Painters={path:new u,text:new h},l.Shapes={_cubeCoordinateMap:[[0,1,3,2],[5,4,6,7],[1,0,4,5],[2,3,7,6],[3,1,5,7],[0,2,6,4]],_mapPointsToSurfaces:function(t,n){var e,r,i,o,s,u;for(o=[],s=0,u=n.length;u>s;s++)r=n[s],i=function(){var n,i,o;for(o=[],n=0,i=r.length;i>n;n++)e=r[n],o.push(t[e].copy());return o}(),o.push(new l.Surface(i));return o},cube:function(){var t;return t=[l.P(-1,-1,-1),l.P(-1,-1,1),l.P(-1,1,-1),l.P(-1,1,1),l.P(1,-1,-1),l.P(1,-1,1),l.P(1,1,-1),l.P(1,1,1)],new l.Shape("cube",l.Shapes._mapPointsToSurfaces(t,l.Shapes._cubeCoordinateMap))},unitcube:function(){var t;return t=[l.P(0,0,0),l.P(0,0,1),l.P(0,1,0),l.P(0,1,1),l.P(1,0,0),l.P(1,0,1),l.P(1,1,0),l.P(1,1,1)],new l.Shape("unitcube",l.Shapes._mapPointsToSurfaces(t,l.Shapes._cubeCoordinateMap))},rectangle:function(t,n){var e,r;return e=function(e,r,i){return l.P(e(t.x,n.x),r(t.y,n.y),i(t.z,n.z))},r=[e(Math.min,Math.min,Math.min),e(Math.min,Math.min,Math.max),e(Math.min,Math.max,Math.min),e(Math.min,Math.max,Math.max),e(Math.max,Math.min,Math.min),e(Math.max,Math.min,Math.max),e(Math.max,Math.max,Math.min),e(Math.max,Math.max,Math.max)],new l.Shape("rect",l.Shapes._mapPointsToSurfaces(r,l.Shapes._cubeCoordinateMap))},tetrahedron:function(){var t,n;return n=[l.P(1,1,1),l.P(-1,-1,1),l.P(-1,1,-1),l.P(1,-1,-1)],t=[[0,2,1],[0,1,3],[3,2,0],[1,2,3]],new l.Shape("tetrahedron",l.Shapes._mapPointsToSurfaces(n,t))},text:function(t){var n;return n=new l.Surface([l.P(0,0,-1),l.P(0,20,-1),l.P(20,0,-1)],l.Painters.text),n.text=t,n.cullBackfaces=!1,new l.Shape("text",[n])},extrude:function(t,n){var e,r,i,o,s,u,a,h;for(null==n&&(n=1),u=[],r=new l.Surface(function(){var n,e,r;for(r=[],n=0,e=t.length;e>n;n++)s=t[n],r.push(s.copy());return r}()),e=new l.Surface(function(){var e,r,i;for(i=[],e=0,r=t.length;r>e;e++)s=t[e],i.push(s.translate(0,0,n));return i}()),i=a=1,h=t.length;h>=1?h>a:a>h;i=h>=1?++a:--a)u.push(new l.Surface([r.points[i-1].copy(),e.points[i-1].copy(),e.points[i].copy(),r.points[i].copy()]));return o=t.length,u.push(new l.Surface([r.points[o-1].copy(),e.points[o-1].copy(),e.points[0].copy(),r.points[0].copy()])),e.points.reverse(),u.push(r),u.push(e),new l.Shape("extrusion",u)},arrow:function(t,n,e,r,i){var o,s;return null==t&&(t=1),null==n&&(n=1),null==e&&(e=1),null==r&&(r=1),null==i&&(i=0),o=e/2,s=[l.P(0,0,0),l.P(r+i,1,0),l.P(r,o,0),l.P(r+n,o,0),l.P(r+n,-o,0),l.P(r,-o,0),l.P(r+i,-1,0)],l.Shapes.extrude(s,t)},path:function(t){return new l.Shape("path",[new l.Surface(t)])},custom:function(t){var n,e,r,i,o,s;for(r=[],s=t.surfaces,i=0,o=s.length;o>i;i++)n=s[i],r.push(new l.Surface(function(){var t,r,i;for(i=[],t=0,r=n.length;r>t;t++)e=n[t],i.push(l.P.apply(l,e));return i}()));return new l.Shape("custom",r)}},l.Projections={perspectiveFov:function(t,n){var e;return null==t&&(t=50),null==n&&(n=1),e=n*Math.tan(t*Math.PI/360),l.Projections.perspective(-e,e,-e,e,n,2*n)},orthoExtent:function(t,n,e){return null==t&&(t=100),null==n&&(n=t),null==e&&(e=n),l.Projections.ortho(-t,t,-n,n,n,2*n)},perspective:function(t,n,e,r,i,o){var s,u,a,h,p;return null==t&&(t=-1),null==n&&(n=1),null==e&&(e=-1),null==r&&(r=1),null==i&&(i=1),null==o&&(o=100),p=2*i,s=n-t,u=r-e,a=o-i,h=new Array(16),h[0]=p/s,h[1]=0,h[2]=(n+t)/s,h[3]=0,h[4]=0,h[5]=p/u,h[6]=(r+e)/u,h[7]=0,h[8]=0,h[9]=0,h[10]=-(o+i)/a,h[11]=-(o*p)/a,h[12]=0,h[13]=0,h[14]=-1,h[15]=0,new l.Matrix(h)},ortho:function(t,n,e,r,i,o){var s,u,a,h,p;return null==t&&(t=-1),null==n&&(n=1),null==e&&(e=-1),null==r&&(r=1),null==i&&(i=1),null==o&&(o=100),p=2*i,s=n-t,u=r-e,a=o-i,h=new Array(16),h[0]=2/s,h[1]=0,h[2]=0,h[3]=(n+t)/s,h[4]=0,h[5]=2/u,h[6]=0,h[7]=-(r+e)/u,h[8]=0,h[9]=0,h[10]=-2/a,h[11]=-(o+i)/a,h[12]=0,h[13]=0,h[14]=0,h[15]=1,new l.Matrix(h)}},l.Viewports={center:function(t,n,e,r){var i,o;return null==t&&(t=500),null==n&&(n=500),null==e&&(e=0),null==r&&(r=0),o=(new l.Matrix).translate(-e,-r,-1).scale(1/t,1/n,1/n),i=(new l.Matrix).scale(t,-n).translate(e+t/2,r+n/2),{prescale:o,postscale:i}},origin:function(t,n,e,r){var i,o;return null==t&&(t=500),null==n&&(n=500),null==e&&(e=0),null==r&&(r=0),o=(new l.Matrix).translate(-e,-r,-1).scale(1/t,1/n,1/n),i=(new l.Matrix).scale(t,-n).translate(e,r),{prescale:o,postscale:i}}},l.Camera=function(){function t(t){l.Util.defaults(this,t,this.defaults)}return t.prototype.defaults={projection:l.Projections.perspective(),viewport:l.Viewports.center(),camera:l.Matrices.identity.copy()},t.prototype.getMatrix=function(){return this.camera.multiply(this.viewport.prescale).multiply(this.projection).multiply(this.viewport.postscale)},t}(),x=function(t){return document.createElementNS("http://www.w3.org/2000/svg",t)},p=function(t){return"M"+t.map(function(t){return""+t.x+" "+t.y}).join("L")},l.SvgRenderer=function(t){function n(){return g=n.__super__.constructor.apply(this,arguments)}return M(n,t),n.prototype.addTo=function(t){return this._g=t},n.prototype.path=function(){var t;return t=this._manifest("path"),{el:t,path:function(n){return t.setAttribute("d",p(n)),this},style:function(n){var e,r,i;r="";for(e in n)i=n[e],r+=""+e+":"+i+";";return t.setAttribute("style",r),this}}},n.prototype.text=function(){var t;return t=this._manifest("text"),t.setAttribute("font-family","Roboto"),{el:t,text:function(n){return t.textContent=n,this},style:function(n){var e,r,i;r="";for(e in n)i=n[e],r+=""+e+":"+i+";";return t.setAttribute("style",r),this},transform:function(n){var e;return e=n.m,t.setAttribute("transform","matrix("+e[0]+" "+e[4]+" "+e[1]+" "+e[5]+" "+e[3]+" "+e[7]+")"),this}}},n.prototype.reset=function(){return this._i=0},n.prototype.hideUnused=function(){var t,n;for(t=this._g.childNodes,n=[];this._i<t.length;)t[this._i].setAttribute("style","display: none;"),n.push(this._i++);return n},n.prototype._manifest=function(t){var n,e,r;return n=this._g.childNodes,this._i>=n.length?(r=x(t),this._g.appendChild(r),this._i++,r):(e=n[this._i],e.tagName===t?(this._i++,e):(r=x(t),this._g.replaceChild(r,e),this._i++,r))},n}(l.Renderer),l.SvgCanvas=function(){function t(t){this.svg=t,this.layers={}}return t.prototype.layer=function(t,n){var e;return e=this.layers[t]=x("g"),this.svg.appendChild(e),null!=n&&n.addTo(e),this},t}(),l.SvgRenderDebug=function(){function t(t){this._renderEnd=w(this._renderEnd,this),this._renderStart=w(this._renderStart,this),this._text=x("text"),this._text.setAttribute("style","text-anchor:end;"),this._text.setAttribute("x",490),this._text.setAttribute("y","20"),this._fps=30,t.on("beforeRender.debug",this._renderStart),t.on("afterRender.debug",this._renderEnd)}return t.prototype.addTo=function(t){return t.appendChild(this._text)},t.prototype._renderStart=function(){return this._renderStartTime=new Date},t.prototype._renderEnd=function(t){var n;return n=1e3/(new Date-this._renderStartTime),0/0!==n&&(this._fps+=(n-this._fps)/20),this._text.textContent="fps: "+this._fps.toFixed(1)+" surfaces: "+t.length},t}(),l.SvgFillRect=function(){function t(t,n){this.width=null!=t?t:500,this.height=null!=n?n:500}return t.prototype.addTo=function(t){var n;return n=x("rect"),n.setAttribute("fill","#EEE"),n.setAttribute("width",this.width),n.setAttribute("height",this.width),t.appendChild(n)},t}(),l.SvgScene=function(t,n,e,r){return null==e&&(e=400),null==r&&(r=400),new l.SvgCanvas(document.getElementById(t)).layer("background",new l.SvgFillRect(e,r)).layer("scene",new l.SvgRenderer(n))},l.Scene=function(){function t(t){this._renderSurfaces=w(this._renderSurfaces,this),this.render=w(this.render,this),l.Util.defaults(this,t,this.defaults),this.dispatch=l.Events.dispatch("beforeRender","afterRender","render"),this.on=this.dispatch.on,this._renderModelCache={}}return t.prototype.defaults={cullBackfaces:!0,camera:new l.Camera,model:new l.Model,shader:l.Shaders.phong},t.prototype.startRenderLoop=function(t){return null==t&&(t=30),setInterval(this.render,t)},t.prototype.render=function(){var t;return this.dispatch.beforeRender(),t=this._renderSurfaces(),this.dispatch.render(t),this.dispatch.afterRender(t),this},t.prototype._renderSurfaces=function(){var t,n,e=this;return t=this.camera.getMatrix(),n=[],this.model.eachRenderable(function(t,n){return new l.LightRenderModel(t,n)},function(r,i,o){var s,u,a,h,l,p,c,f;for(l=r.surfaces,f=[],a=0,h=l.length;h>a;a++)u=l[a],s=e._renderSurface(u,o,t),!e.cullBackfaces||!u.cullBackfaces||s.projected.normal.z<0?(s.fill=null!=(p=u.fill)?p.render(i,e.shader,s.transformed):void 0,s.stroke=null!=(c=u.stroke)?c.render(i,e.shader,s.transformed):void 0,f.push(n.push(s))):f.push(void 0);return f}),n.sort(function(t,n){return n.projected.barycenter.z-t.projected.barycenter.z}),n},t.prototype._renderSurface=function(t,n,e){var r;return r=this._renderModelCache[t.id],null==r?r=this._renderModelCache[t.id]=new l.RenderModel(t,n,e):r.update(n,e),r},t}()}).call(this);